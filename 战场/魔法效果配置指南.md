# 魔法效果配置指南

## 核心发现

### 效果系统架构
- **不是所有魔法都需要特殊动画**
- 需要特殊视觉效果的魔法必须在客户端代码中硬编码case
- 这是老游戏的标准做法，特效通过代码而非配置文件控制

### 效果ID计算公式
```
效果ID = 魔法ID + 100
```

**示例：**
- 魔法箭 (ID 0) → 效果ID 100
- 暴雪 (ID 91) → 效果ID 191
- 冰天雪地 (ID 97) → 效果ID 197

---

## 魔法效果分类

### 1. 无视觉效果魔法
- 纯状态效果（buff/debuff）
- 只改变属性，无动画
- **不需要case**

### 2. 通用视觉效果魔法
- 复用已有的爆炸、箭矢等效果（effect 1-99）
- **不需要专门的case**

### 3. 特殊视觉效果魔法
- 有独特动画的魔法（如暴雪、流星攻击等）
- **必须添加case**

---

## 客户端效果处理流程

### 第一步：服务器发送效果
**文件：** `HGServer/NewPartySystem.cpp` 第25329行
```cpp
SendEventToNearClient_TypeB(..., (sType+100), ...);
// sType = 魔法ID
// 发送效果ID = 魔法ID + 100
```

### 第二步：客户端接收
**文件：** `HGClient/Game.cpp` 第6974行
```cpp
case DEF_COMMONTYPE_MAGIC:
    bAddNewEffect(sV3, sX, sY, sV1, sV2, 0, sV4); 
    // sV3 = 效果ID (魔法ID + 100)
```

### 第三步：初始化效果
**文件：** `HGClient/NotifyMsgHandler.cpp` bAddNewEffect函数

**关键：** 如果效果ID没有对应的case，会被default分支删除：
```cpp
default:
    delete m_pEffectList[i]; 
    m_pEffectList[i] = NULL; 
    break;
```

### 第四步：绘制效果
**文件：** `HGClient/Game.cpp` 或 `HGClient/NotifyMsgHandler.cpp` DrawEffects函数

---

## Effect Pak资源索引表

| Pak文件 | 起始索引 | 数量 | 索引范围 | 代码位置 |
|---------|---------|------|---------|---------|
| effect.pak | 0 | 10 | 0-9 | Game.cpp:5477 |
| effect2.pak | 10 | 3 | 10-12 | Game.cpp:5478 |
| effect3.pak | 13 | 6 | 13-18 | Game.cpp:5479 |
| effect4.pak | 19 | 5 | 19-23 | Game.cpp:5480 |
| effect5.pak | 24 | 7 | 24-30 | Game.cpp:5481-5489 |
| CruEffect1.pak | 31 | 9 | 31-39 | Game.cpp:5490 |
| effect6.pak | 40 | 5 | 40-44 | Game.cpp:5491 |
| **effect7.pak** | **45** | **12** | **45-56** | Game.cpp:5492 |
| effect8.pak | 57 | 9 | 57-65 | Game.cpp:5493 |
| effect9.pak | 66 | 21 | 66-86 | Game.cpp:5494 |
| effect10.pak | 87 | 2 | 87-88 | Game.cpp:5496 |
| effect11.pak | 89 | 14 | 89-102 | Game.cpp:5497 |
| effect11s.pak | 104 | 18 | 104-121 | Game.cpp:5499 |

**加载代码示例：**
```cpp
pGame->MakeEffectSpr("effect7", 45, 12, FALSE);
// 参数1: pak文件名（不含.pak）
// 参数2: 起始索引
// 参数3: 加载帧数
// 参数4: 是否alpha
```

**索引计算公式：**
```
m_pEffectSpr[索引] = pak起始索引 + pak内帧号
```

---

## 暴雪(ID 91)效果分析

### 完整流程

#### 1. 服务器发送
```cpp
// NewPartySystem.cpp:25329
SendEventToNearClient_TypeB(..., 91+100, ...); // 发送191
```

#### 2. 客户端接收并初始化
```cpp
// NotifyMsgHandler.cpp:42274 - bAddNewEffect中
case 191: // Blizzard
    m_pEffectList[i]->m_cMaxFrame   = 7;    // 7帧动画
    m_pEffectList[i]->m_dwFrameTime = 80;   // 每帧80ms
    break;
```

#### 3. 主循环创建子效果
```cpp
// Game.cpp:18005 - DrawEffects中
case 191: // Blizzard
    if(m_pEffectList[i]->m_cFrame > m_pEffectList[i]->m_cMaxFrame)
    {
        delete m_pEffectList[i]; 
        m_pEffectList[i] = NULL; 
    }
    else
    {
        // 每帧创建飞雪效果71
        bAddNewEffect(71, m_pEffectList[i]->m_sX, m_pEffectList[i]->m_sY, 
                      m_pEffectList[i]->m_dX*32 +(rand()%120)-60, 
                      m_pEffectList[i]->m_dY*32 +(rand()%120)-60, 0); 
        PlaySound('E', 1, sDist, lPan); 
    }
    break;
```

#### 4. 效果71初始化
```cpp
// NotifyMsgHandler.cpp:41887 - bAddNewEffect中
case 71:
    m_pEffectList[i]->m_mX     = sX*32; 
    m_pEffectList[i]->m_mY     = sY*32; 
    m_pEffectList[i]->m_iErr   = 0; 
    m_pEffectList[i]->m_cMaxFrame   = NULL;  // 无限循环
    m_pEffectList[i]->m_dwFrameTime = 20; 
    break;
```

#### 5. 效果72实际绘制
```cpp
// NotifyMsgHandler.cpp:42842 - DrawEffects中
case 72: // Blizzard
    cTempFrame = m_pEffectList[i]->m_cFrame; 
    if(cTempFrame < 0) break; 
    dX  = (m_pEffectList[i]->m_mX)  - m_sViewPointX; 
    dY  = (m_pEffectList[i]->m_mY)  - m_sViewPointY; 
    if(cTempFrame <= 8)
    {
        iDvalue = 0; 
        m_pEffectSpr[51]->PutTransSpriteRGB(dX, dY, cTempFrame, 
                                            iDvalue, iDvalue, iDvalue, dwTime); 
    }
    else
    {
        iDvalue = -1*(cTempFrame - 8); 
        m_pEffectSpr[51]->PutTransSpriteRGB(dX, dY, 8, 
                                            iDvalue, iDvalue, iDvalue, dwTime);
    }
    break;
```

### 资源定位
- **使用sprite索引：** m_pEffectSpr[51]
- **对应pak文件：** effect7.pak
- **pak内位置：** 51 - 45(起始索引) = **第6帧**（从0开始）
- **动画帧数：** 0-8共9帧，淡出效果

### 三层效果系统
```
效果191 (主控制器)
    └─> 每帧创建 效果71 (中间层)
            └─> 实际绘制使用 效果72 (绘制层)
                    └─> 使用 m_pEffectSpr[51] (effect7.pak第6帧)
```

---

## 添加新魔法效果的完整步骤

### 前提条件
- 已准备好帧动画资源（.spr或pak格式）
- 确定魔法ID（本例使用97 - 冰天雪地）
- 效果ID = 97 + 100 = 197

### 步骤详解

#### 步骤1：添加动画资源到pak文件

**方案A：添加到现有pak（推荐）**
1. 使用pak编辑工具打开`effect7.pak`（或其他pak）
2. 添加新的sprite帧序列
3. 记录添加的位置（例如：第13-20帧，共8帧）
4. 保存pak文件

**方案B：创建新pak文件**
1. 创建`effect13.pak`
2. 添加sprite帧序列
3. 修改`Game.cpp`加载代码（约第5500行）：
```cpp
pGame->MakeEffectSpr("effect13", 200, 10, FALSE);
// 加载到索引200-209
```

#### 步骤2：配置bAddNewEffect（初始化）

**文件：** `HGClient/NotifyMsgHandler.cpp`
**位置：** bAddNewEffect函数的switch语句中（约42274行）

**添加代码：**
```cpp
case 191: // Blizzard
    m_pEffectList[i]->m_cMaxFrame   = 7; 
    m_pEffectList[i]->m_dwFrameTime = 80; 
    break; 

case 197: // 冰天雪地
    m_pEffectList[i]->m_cMaxFrame   = 7;     // 持续7帧
    m_pEffectList[i]->m_dwFrameTime = 80;    // 每帧80毫秒
    break;
```

**参数说明：**
- `m_cMaxFrame`: 效果持续的帧数（控制循环次数）
- `m_dwFrameTime`: 每帧间隔时间（毫秒）

#### 步骤3：配置DrawEffects（主循环）

**文件：** `HGClient/Game.cpp`
**位置：** DrawEffects或类似的更新函数中（约18005行）

**方案A：复用暴雪逻辑**
```cpp
case 191: // Blizzard
case 197: // 冰天雪地（使用相同逻辑）
    if(m_pEffectList[i]->m_cFrame > m_pEffectList[i]->m_cMaxFrame)
    {
        delete m_pEffectList[i]; 
        m_pEffectList[i] = NULL; 
    }
    else
    {
        // 创建飞雪效果
        bAddNewEffect(71, m_pEffectList[i]->m_sX, m_pEffectList[i]->m_sY, 
                      m_pEffectList[i]->m_dX*32 +(rand()%120)-60, 
                      m_pEffectList[i]->m_dY*32 +(rand()%120)-60, 0); 
        PlaySound('E', 1, sDist, lPan); 
    }
    break;
```

**方案B：使用新的子效果**
```cpp
case 197: // 冰天雪地（使用新动画）
    if(m_pEffectList[i]->m_cFrame > m_pEffectList[i]->m_cMaxFrame)
    {
        delete m_pEffectList[i]; 
        m_pEffectList[i] = NULL; 
    }
    else
    {
        // 创建新的冰雪效果74
        bAddNewEffect(74, m_pEffectList[i]->m_sX, m_pEffectList[i]->m_sY, 
                      m_pEffectList[i]->m_dX*32 +(rand()%100)-50, 
                      m_pEffectList[i]->m_dY*32 +(rand()%100)-50, 0); 
        PlaySound('E', 1, sDist, lPan); 
    }
    break;
```

#### 步骤4：配置子效果初始化（如果使用新效果）

**文件：** `HGClient/NotifyMsgHandler.cpp`
**位置：** bAddNewEffect函数中

```cpp
case 74: // 冰天雪地子效果
    m_pEffectList[i]->m_mX     = sX*32; 
    m_pEffectList[i]->m_mY     = sY*32; 
    m_pEffectList[i]->m_iErr   = 0; 
    m_pEffectList[i]->m_cMaxFrame   = 8;     // 8帧动画
    m_pEffectList[i]->m_dwFrameTime = 30;    // 每帧30ms
    break;
```

#### 步骤5：配置绘制逻辑

**文件：** `HGClient/NotifyMsgHandler.cpp`
**位置：** DrawEffects函数中（约42842行）

**方案A：复用暴雪的sprite（m_pEffectSpr[51]）**
```cpp
case 72: // Blizzard
case 74: // 冰天雪地（使用暴雪动画）
    cTempFrame = m_pEffectList[i]->m_cFrame; 
    if(cTempFrame < 0) break; 
    dX  = (m_pEffectList[i]->m_mX)  - m_sViewPointX; 
    dY  = (m_pEffectList[i]->m_mY)  - m_sViewPointY; 
    if(cTempFrame <= 8)
    {
        iDvalue = 0; 
        m_pEffectSpr[51]->PutTransSpriteRGB(dX, dY, cTempFrame, 
                                            iDvalue, iDvalue, iDvalue, dwTime); 
    }
    else
    {
        iDvalue = -1*(cTempFrame - 8); 
        m_pEffectSpr[51]->PutTransSpriteRGB(dX, dY, 8, 
                                            iDvalue, iDvalue, iDvalue, dwTime);
    }
    break;
```

**方案B：使用新添加的sprite**
```cpp
case 74: // 冰天雪地（使用新动画）
    cTempFrame = m_pEffectList[i]->m_cFrame; 
    if(cTempFrame < 0) break; 
    dX  = (m_pEffectList[i]->m_mX)  - m_sViewPointX; 
    dY  = (m_pEffectList[i]->m_mY)  - m_sViewPointY; 
    
    // 假设添加到effect7.pak的第13-20帧
    // effect7起始索引45，所以使用m_pEffectSpr[45+13]=m_pEffectSpr[58]
    // 或者添加到新pak effect13，使用m_pEffectSpr[200]
    
    m_pEffectSpr[58]->PutTransSprite_NoColorKey(dX, dY, cTempFrame, dwTime);
    break;
```

---

## 实战示例：为冰天雪地添加新动画

### 假设条件
- 新动画添加到`effect8.pak`（索引范围57-65）
- 动画占用第9-16帧（共8帧）
- effect8起始索引57，所以使用 m_pEffectSpr[57+9] = m_pEffectSpr[66]
- **等等，66已超出effect8范围！**
- 改为添加到`effect9.pak`（索引范围66-86）
- 使用m_pEffectSpr[66]开始的8帧

### 代码实现

#### 1. bAddNewEffect初始化
```cpp
// NotifyMsgHandler.cpp 约42274行
case 197: // 冰天雪地
    m_pEffectList[i]->m_cMaxFrame   = 10;    // 持续10帧
    m_pEffectList[i]->m_dwFrameTime = 100;   // 每帧100ms
    break;
```

#### 2. Game.cpp主循环
```cpp
// Game.cpp 约18020行
case 197: // 冰天雪地
    if(m_pEffectList[i]->m_cFrame > m_pEffectList[i]->m_cMaxFrame)
    {
        delete m_pEffectList[i]; 
        m_pEffectList[i] = NULL; 
    }
    else
    {
        // 创建冰晶效果75
        bAddNewEffect(75, m_pEffectList[i]->m_sX, m_pEffectList[i]->m_sY, 
                      m_pEffectList[i]->m_dX*32 +(rand()%140)-70, 
                      m_pEffectList[i]->m_dY*32 +(rand()%140)-70, 0); 
        PlaySound('E', 1, sDist, lPan); 
    }
    break;
```

#### 3. 子效果75初始化
```cpp
// NotifyMsgHandler.cpp bAddNewEffect中
case 75: // 冰晶飞舞
    m_pEffectList[i]->m_mX     = sX*32; 
    m_pEffectList[i]->m_mY     = sY*32; 
    m_pEffectList[i]->m_iErr   = 0; 
    m_pEffectList[i]->m_cMaxFrame   = 7;     // 7帧动画
    m_pEffectList[i]->m_dwFrameTime = 40;    // 每帧40ms
    break;
```

#### 4. 效果75绘制
```cpp
// NotifyMsgHandler.cpp DrawEffects中
case 75: // 冰晶飞舞
    cTempFrame = m_pEffectList[i]->m_cFrame; 
    if(cTempFrame < 0 || cTempFrame > 7) break; 
    dX  = (m_pEffectList[i]->m_mX)  - m_sViewPointX; 
    dY  = (m_pEffectList[i]->m_mY)  - m_sViewPointY; 
    
    // 使用effect9.pak中的动画（索引66开始）
    m_pEffectSpr[66]->PutTransSprite_NoColorKey(dX, dY, cTempFrame, dwTime);
    break;
```

---

## 常用绘制函数说明

### PutTransSprite_NoColorKey
```cpp
m_pEffectSpr[index]->PutTransSprite_NoColorKey(x, y, frame, time);
```
- 标准透明绘制
- 无颜色键，使用alpha通道

### PutTransSpriteRGB
```cpp
m_pEffectSpr[index]->PutTransSpriteRGB(x, y, frame, r, g, b, time);
```
- 带RGB调色的透明绘制
- r, g, b为颜色偏移值（负数变暗，正数变亮）
- 用于淡入淡出效果

### PutSpriteFast
```cpp
m_pEffectSpr[index]->PutSpriteFast(x, y, frame, time);
```
- 快速绘制，无透明处理
- 性能最好

### PutTransSprite25_NoColorKey
```cpp
m_pEffectSpr[index]->PutTransSprite25_NoColorKey(x, y, frame, time);
```
- 25%透明度绘制

---

## 检查清单

添加新魔法效果前，确认以下事项：

- [ ] 魔法ID已在服务器`Magic.cfg`中配置
- [ ] 计算效果ID（魔法ID + 100）
- [ ] 动画资源已添加到pak文件
- [ ] 确认sprite索引范围不冲突
- [ ] 在`bAddNewEffect`中添加case（初始化）
- [ ] 在主循环中添加case（可选，如需持续效果）
- [ ] 在`DrawEffects`中添加case（实际绘制）
- [ ] 测试帧数、时间参数
- [ ] 添加音效（可选）
- [ ] 添加屏幕震动（可选）

---

## 常见问题

### Q1: 动画不显示怎么办？
1. 检查default分支是否删除了效果
2. 确认pak文件已正确加载
3. 验证sprite索引计算是否正确
4. 检查帧数范围是否超出pak内容

### Q2: 如何复用现有动画？
直接在case中使用已有的effect编号和sprite索引：
```cpp
case 197: // 使用暴雪动画
case 191: // Blizzard
    // 相同的处理代码
```

### Q3: 如何调整动画速度？
修改`m_dwFrameTime`参数：
- 值越小，动画越快
- 值越大，动画越慢
- 单位：毫秒

### Q4: 如何添加淡出效果？
参考暴雪的做法，使用PutTransSpriteRGB调整RGB值：
```cpp
if(cTempFrame <= 8)
    iDvalue = 0;  // 正常亮度
else
    iDvalue = -1*(cTempFrame - 8);  // 逐渐变暗
m_pEffectSpr[51]->PutTransSpriteRGB(dX, dY, frame, iDvalue, iDvalue, iDvalue, dwTime);
```

---

## 总结

- **硬编码架构**：老游戏的特效系统通过代码而非配置文件控制
- **三层结构**：主效果 → 子效果 → 实际绘制
- **索引系统**：pak文件通过起始索引和数量加载到m_pEffectSpr数组
- **必需步骤**：初始化、循环、绘制三个case缺一不可
- **灵活复用**：可以复用现有动画避免重复开发

**关键提醒：** 每次修改客户端代码后需要重新编译并分发更新包给玩家！
