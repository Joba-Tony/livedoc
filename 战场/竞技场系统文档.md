# 竞技场(副本)系统文档

## 概述

竞技场（fightzone）是一个副本系统：
- 玩家使用**入场券**直接进入副本
- 进入后有**固定时间限制**（可配置）
- 时间到或主动回城会自动传送出副本
- 副本内可以设置怪物，玩家击杀怪物获取材料

---

## 一、副本时间配置

### 1.1 地图配置文件

每个副本地图可以单独配置停留时间，在地图配置文件 `mapdata/fightzone*.txt` 中添加：

```ini
force-recall-time = 1800  // 单位：秒，1800秒=30分钟
```

**配置说明**：
- 0 或不配置：使用旧的系统时间周期计算（兼容模式）
- 大于0：玩家进入后开始计时，时间到自动传送出副本

### 1.2 配置示例

`fightzone1.txt`（30分钟副本）：
```ini
[MAP-INFO]
map-location  = fightzone1
force-recall-time = 1800
...
[END-MAP-INFO]
```

`fightzone2.txt`（1小时副本）：
```ini
[MAP-INFO]
map-location  = fightzone2
force-recall-time = 3600
...
[END-MAP-INFO]
```

### 1.3 时间单位换算

| 配置值 | 实际时间 |
|--------|----------|
| 300 | 5分钟 |
| 600 | 10分钟 |
| 900 | 15分钟 |
| 1800 | 30分钟 |
| 3600 | 1小时 |
| 7200 | 2小时 |

---

## 二、入场券配置

### 2.1 物品配置格式

入场券在 `item2.cfg` 中配置，格式如下：

```
Item = ID  名称  类型  位置  效果类型  E1  E2  ...
```

**关键字段**：
| 字段 | 值 | 说明 |
|------|------|------|
| 类型 | 3 | DEF_ITEMTYPE_USE_DELETE（使用后消耗） |
| 效果类型 | 11 | 传送效果 |
| E1 | 4 | 传送子类型（竞技场传送） |
| E2 | 11-19 | 目标副本编号+10 |

### 2.2 目标副本计算

```
目标副本 = E2值 - 10
```

| E2值 | 目标地图 |
|------|----------|
| 11 | fightzone1 |
| 12 | fightzone2 |
| 13 | fightzone3 |
| ... | ... |
| 19 | fightzone9 |

### 2.3 当前入场券列表

| ID | 名称 | E2值 | 目标地图 |
|---|---|---|---|
| 457 | 竞技场入场卷(阿) | 11 | fightzone1 |
| 458 | 竞技场入场卷(爱) | 12 | fightzone2 |
| 511 | ArenaTicket | 11 | fightzone1 |
| 513 | ArenaTicket(2) | 12 | fightzone2 |
| 515 | ArenaTicket(3) | 13 | fightzone3 |
| 517 | ArenaTicket(4) | 14 | fightzone4 |
| 530 | ArenaTicket(5) | 15 | fightzone5 |
| 531 | ArenaTicket(6) | 16 | fightzone6 |
| 532 | ArenaTicket(7) | 17 | fightzone7 |
| 533 | ArenaTicket(8) | 18 | fightzone8 |
| 534 | ArenaTicket(9) | 19 | fightzone9 |

### 2.4 添加新入场券

1. 在 `item2.cfg` 中添加配置：
```
Item = 新ID  入场券名称  3  0  11  4  目标E2值  0  0  0  0  0  0  1  0  6  89  -100  1  -1  0  0  0  0  0  -1  42  0  0
```

2. E2值计算：`E2 = 目标fightzone编号 + 10`

---

## 三、使用流程

1. **获取入场券**：通过NPC购买、活动奖励等方式获得
2. **使用入场券**：双击使用，自动传送到对应副本
3. **副本计时**：进入副本后开始倒计时（根据地图配置）
4. **自动传送**：时间到或主动回城，传送回出生点
5. **物品消耗**：入场券在传送成功后自动消耗

---

## 四、相关代码位置

| 功能 | 文件 | 说明 |
|------|------|------|
| 入场券使用逻辑 | HGServer/Game.cpp | UseItemHandler函数中case 11-19 |
| 地图时间配置读取 | HGServer/Game.cpp | bReadMapInfoFile函数case 30 |
| 时间变量定义 | HGServer/Map.h | m_iForceRecallTime |
| 时间变量初始化 | HGServer/Map.cpp | 构造函数中初始化为0 |
| ForceRecall计算 | HGServer/Game.cpp | 进入地图时设置m_iTimeLeft_ForceRecall |
| 入场券配置 | WorldServer/item2.cfg | 物品ID 457-458, 511-534 |
| 地图配置 | GameServer/mapdata/fightzone*.txt | force-recall-time选项 |

---

## 五、配置修改记录

### 已完成

1. ? **入场券直接传送**：
   - 移除旧的时间检查逻辑
   - 使用入场券直接传送到目标副本
   - 传送成功后自动消耗入场券

2. ? **副本时间独立配置**：
   - 在Map.h添加 `m_iForceRecallTime` 变量
   - 支持每个地图单独配置 `force-recall-time`
   - 玩家进入副本后开始计时，不再依赖系统时间周期

3. ? **入场券457/458修复**：
   - 类型从15改为3（使用类物品）
   - 效果类型设置为11（传送效果）
   - E1=4, E2=11/12

4. ? **示例配置**：
   - fightzone1.txt 添加 `force-recall-time = 1800` (30分钟)
