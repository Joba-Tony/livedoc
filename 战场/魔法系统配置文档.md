# 魔法系统配置文档

## 一、配置文件位置

### 服务器端
- **路径**: `Server\WorldServer\Magic.cfg`
- **作用**: 魔法伤害、消耗、范围等游戏逻辑
- **重启**: 修改后需重启服务器

### 客户端
- **路径**: `New Client\CONTENTS\MAGICCFG.txt`
- **作用**: 魔法UI显示、学习费用
- **重启**: 修改后需重启客户端

---

## 二、快速配置指南 (新手必读)

### ? 我想创建一个新魔法,该怎么做?

**步骤概览**:
1. 确定魔法ID (0-99中选一个未使用的)
2. 配置伤害和范围
3. 选择魔法类型(Type)和属性(Attr)
4. 添加图标资源
5. 添加动画效果(可选)

---

### ? 伤害配置详解

#### 伤害公式:
```
实际伤害 = 基础伤害 + 额外伤害 × (熟练度/100) + 随机波动
```

#### 配置示例:
```properties
magic = 50  火球术  3  0  0  30  2  2  10 15 25  5 8 15  0 0 0  50  1  1  3
                                      ^^^^^^^^  ^^^^^^^
                                      基础伤害   额外伤害
```

**基础伤害 (effect4, effect5, effect6)**:
- **effect4 (最小伤害)**: 10 → 至少造成10点伤害
- **effect5 (基础伤害)**: 15 → 平均造成15点伤害
- **effect6 (最大伤害)**: 25 → 最多造成25点伤害

**额外伤害 (effect7, effect8, effect9)** - 随魔法熟练度提升:
- **effect7**: 5 → 熟练度100%时额外+5最小伤害
- **effect8**: 8 → 熟练度100%时额外+8基础伤害  
- **effect9**: 15 → 熟练度100%时额外+15最大伤害

**实战举例**:
- 新手(熟练度0%): 伤害范围 **10-25**, 平均**15**
- 熟练(熟练度50%): 伤害范围 **12-32**, 平均**19**
- 大师(熟练度100%): 伤害范围 **15-40**, 平均**23**

#### ? 配置建议:
| 魔法等级 | 最小伤害 | 基础伤害 | 最大伤害 | 额外伤害倍数 |
|---------|---------|---------|---------|-------------|
| 初级 (1-20级) | 2-5 | 5-10 | 10-20 | 0.3-0.5倍 |
| 中级 (20-50级) | 5-10 | 10-20 | 20-40 | 0.5-0.8倍 |
| 高级 (50-80级) | 10-20 | 20-40 | 40-80 | 0.8-1.2倍 |
| 终极 (80+级) | 20-30 | 30-60 | 60-120 | 1.0-1.5倍 |

---

### ? 范围配置详解

#### 范围参数 (range2, range3):
```properties
magic = 50  火球术  3  0  0  30  2  2  ...
                                   ^^^^
                                   范围参数
```

**计算公式**:
```
实际范围 = (range2 × 2 + 1) × (range3 × 2 + 1) 格
```

**常用配置**:
| range2 | range3 | 实际范围 | 视觉效果 |
|--------|--------|---------|---------|
| 0 | 0 | 1×1 (单点) | 只打中心点 |
| 1 | 1 | 3×3 (9格) | 小范围AOE |
| 2 | 2 | 5×5 (25格) | 中范围AOE |
| 3 | 3 | 7×7 (49格) | 大范围AOE |
| 4 | 4 | 9×9 (81格) | 超大范围 |

**?? 注意**: 
- 单体魔法: range2=0, range3=0
- 小范围群攻: range2=1, range3=1
- 大范围群攻: range2=3, range3=3

---

### ? 属性 (Attr) 选择

| Attr值 | 属性类型 | 视觉效果 | 特殊效果 |
|--------|---------|---------|---------|
| 0 | 无属性 | 白色/紫色光效 | 纯魔法伤害,无额外效果 |
| 2 | 魔法属性 | 蓝色能量 | 纯能量伤害 |
| 3 | **火属性** | 红色/橙色火焰 | 火焰伤害,可能燃烧 |
| 4 | **冰属性** | 蓝色/白色冰晶 | 冰霜伤害,可能减速 |

**推荐搭配**:
- 单体高伤: Attr=0 (无属性)
- 群体火攻: Attr=3 (火属性)
- 控制减速: Attr=4 (冰属性)

---

### ?? Type (魔法类型) 详解

**Type决定了魔法的伤害机制和范围判定方式!**

| Type | 类型名称 | 伤害方式 | 推荐用途 |
|------|---------|---------|---------|
| **1** | 单点伤害 | 只打1个目标 | 单体输出技能 |
| **3** | 范围爆炸 | 范围内一次性伤害 | 普通AOE |
| **21** | 流星群攻 | 范围内多次伤害 | 多段AOE |
| **23** | 冰霜范围 | 范围伤害+减速 | 控制型AOE |
| **27** | **持续伤害** | 范围内**持续多段**伤害 | 高伤AOE,类似暴雪 |
| **30** | 地震 | 范围伤害+震荡 | 破甲型AOE |

**?? 重点**: Type 27 是最强的群攻类型,会自动产生多段伤害!

---

### ? 完整配置模板

#### 模板1: 单体高伤魔法
```properties
# 服务器 Magic.cfg
magic = 50  烈焰箭  1  0  0  30  0  0  15 20 30  8 10 15  0 0 0  50  1  1  3
#           ID 名称 单体 延迟 持续 MP  单点范围  基础伤害  额外伤害  特效 需求 费用 攻击 火属性
```

#### 模板2: 中范围AOE
```properties
# 服务器 Magic.cfg
magic = 51  火球术  3  0  0  50  2  2  10 15 25  5 8 15  0 0 0  80  1  1  3
#           ID 名称 范围爆炸 MP 5x5范围 基础伤害 额外伤害 特效 需求 费用 攻击 火属性
```

#### 模板3: 大范围持续伤害 (类似暴雪)
```properties
# 服务器 Magic.cfg
magic = 52  火雨  27  0  0  100  3  3  8 12 20  10 15 25  0 0 0  120  1  1  3
#           ID 名称 持续型 MP  7x7范围  基础伤害  额外伤害  无特效 需求 费用 攻击 火属性
```

---

## 三、服务器端配置字段详解 (Magic.cfg)

### 配置格式
```
magic = ID  名称  Type  Delay  Last  ManaCost  range2  range3  effect4  effect5  effect6  effect7  effect8  effect9  effect10  effect11  effect12  ReqInt  Cost  Caty  Attr
```

### 字段详细说明表

| 序号 | 字段名 | 数据类型 | 实际取值范围 | 字段含义 | 实际配置示例 |
|------|--------|---------|------------|---------|-------------|
| 1 | **ID** | int | 0-99 | 魔法唯一ID编号 | `0`=魔法箭, `20`=火球术, `91`=暴雪, `97`=混沌圣火 |
| 2 | **名称** | string | 中文 | 魔法显示名称 | `魔法箭`, `火球术`, `暴雪`, `混沌圣火` |
| 3 | **Type** | int | 见Type表 | 魔法类型,决定伤害机制 | `1`=单体, `3`=范围爆炸, `27`=持续伤害 |
| 4 | Delay | int | 0-1000 | 施法延迟(毫秒) | 攻击魔法填`0`, 几乎不用 |
| 5 | Last | int | 0-180 | 持续时间(秒) | `0`=瞬发, `30`=30秒, `60`=1分钟, `180`=3分钟 |
| 6 | **ManaCost** | int | 8-900 | MP消耗 | `8`(魔法箭), `27`(火球术), `170`(暴雪), `200`(混沌圣火) |
| 7 | **range2** | int | 0-4 | X轴范围半径 | `0`=单点, `1`=3x3, `2`=5x5, `3`=7x7, `4`=9x9 |
| 8 | **range3** | int | 0-4 | Y轴范围半径 | 通常与range2相同 |
| 9 | **effect4** | int | 0-50 | 基础最小伤害 | `1`(魔法箭), `6`(暴雪), `8`(混沌圣火) |
| 10 | **effect5** | int | 0-100 | 基础平均伤害 | `8`(魔法箭), `5`(暴雪), `7`(混沌圣火) |
| 11 | **effect6** | int | 0-150 | 基础最大伤害 | `0`(魔法箭), `21`(暴雪), `28`(混沌圣火) |
| 12 | **effect7** | int | 0-50 | 额外最小伤害(熟练度) | `0`(魔法箭), `7`(暴雪), `9`(混沌圣火) |
| 13 | **effect8** | int | 0-80 | 额外平均伤害(熟练度) | `0`(魔法箭), `8`(暴雪), `10`(混沌圣火) |
| 14 | **effect9** | int | 0-120 | 额外最大伤害(熟练度) | `0`(魔法箭), `20`(暴雪), `26`(混沌圣火) |
| 15 | effect10 | int | 0-100 | 特殊效果参数1 | `0`=无, `20`=禁锢20秒(暴雪), `10`=持续10次(毒云) |
| 16 | effect11 | int | 0-10 | 特殊效果参数2 | `0`=无, `2`=毒伤频率 |
| 17 | effect12 | int | 0-10 | 特殊效果参数3 | `0`=无, `1-2`=毒云相关 |
| 18 | **ReqInt** | int | 0-500 | 学习所需智力 | `18`(魔法箭), `200`(暴雪), `180`(混沌圣火) |
| 19 | Cost | int | -1或正整数 | 学习费用(金币) | `-1`=不可学, `1`=1金币, `100`=100金币 |
| 20 | Caty | int | 0或1 | 魔法类别 | `0`=辅助类(治疗/BUFF), `1`=攻击类 |
| 21 | **Attr** | int | 0/1/2/3/4 | 魔法属性 | `0`=无, `1`=毒, `2`=魔法, `3`=火, `4`=冰 |

### Type值对照表 (根据实际代码)

| Type | 类型名称 | 实际效果 | 游戏中实例 |
|------|---------|---------|-----------|
| **1** | 单点伤害 | 只打1个目标 | 魔法箭(0), 电击箭(37), 雷击术(43) |
| **2** | 单点治疗 | 恢复1个目标HP | 治愈之光(1), 圣疗之光(21) |
| **3** | 范围爆炸 | 范围内一次性伤害 | 魔法弹(10), 火球术(20), 烈焰冲击(30) |
| **5** | 范围吸血 | 范围内吸收HP | 精血吞蚀(11) |
| **7** | 范围BUFF | 范围加属性 | 勇者之光(23), 神者之光(28) |
| **8** | 传送 | 回城 | 回传术(12) |
| **9** | 召唤 | 召唤NPC | 召唤生物(31) |
| **10** | 制造 | 创建物品 | 制造食物(2) |
| **11** | 护盾 | 防御BUFF | 魔法护盾(13), 圣结界(24), 魔结界(33) |
| **12** | 定身 | 禁止移动 | 定身咒(25), 妖缚咒(35) |
| **13** | 隐身 | 隐身BUFF | 隐身术(32), 侦测隐形(34) |
| **14** | 毒云 | 持续毒伤范围 | 烈焰之牢(40), 毒云(46), 魔之陷(54) |
| **15** | 取物 | 远程拾取 | 隔空取物(26) |
| **16** | 混乱 | 控制类debuff | 封言针(42), 封言钉(62), 梦幻(80) |
| **17** | 单点毒 | 单体持续毒伤 | 剧毒之吻(27), 剧毒之牙(53) |
| **18** | 狂暴 | 攻击力BUFF | 狂暴攻击(50) |
| **19** | 直线伤害 | 直线范围伤害 | 狂雷(51), 血色冲击波(70) |
| **21** | 流星群攻 | 范围多次伤害 | 魔能冲击(60), 神之怒(74), 流星攻击(81) |
| **22** | 震动 | 范围震荡 | 魔震波(38) |
| **23** | 冰霜范围 | 范围冰伤+减速 | 冰风之吻(45), 冰风暴(57), 冰风怒吼(63) |
| **25** | 吸耐伤害 | 伤害+吸耐力 | 地虫怒吼(64) |
| **26** | 破甲 | 范围破装甲 | 暗黑之云(66) |
| **27** | **持续伤害** | **范围持续多段伤害** | **暴雪(91), 混沌圣火(97)** |
| **28** | 解除 | 解除负面状态 | 解除魔法(76) |
| **29** | 封魔 | 禁止施法 | 封魔咒(83) |
| **30** | 地震 | 范围震荡+破甲 | 地震(96) |
| **32** | 复活 | 复活玩家 | 复活(94) |

### Attr属性对照表

| Attr | 属性名称 | 视觉效果 | 游戏中实例 |
|------|---------|---------|-----------|
| **0** | 无属性 | 白色/紫色光效 | 魔法弹(10), 勇者之光(23), 狂暴(50) |
| **1** | 毒属性 | 绿色毒雾 | 剧毒之吻(27), 魔震波(38), 毒云(46) |
| **2** | 魔法属性 | 蓝色能量 | 魔法箭(0), 电击箭(37), 魔能冲击(60) |
| **3** | **火属性** | 红色/橙色火焰 | 火球术(20), 烈焰冲击(30), 流星攻击(81), **混沌圣火(97)** |
| **4** | **冰属性** | 蓝色/白色冰晶 | 治愈之光(1), 冰风之吻(45), 暴雪(91) |

---

## 四、客户端配置字段详解 (MAGICCFG.txt)

### 配置格式
```
magic = ID  名称  ManaCost  ReqInt  Cost  Menu1 Menu2 Menu3  Display
```

### 字段详细说明表

| 序号 | 字段名 | 数据类型 | 实际取值范围 | 字段含义 | 实际配置示例 |
|------|--------|---------|------------|---------|-------------|
| 1 | **ID** | int | 0-99 | 魔法ID,必须与服务器一致 | `0`, `20`, `91`, `97` |
| 2 | **名称** | string | 中文 | 显示名称,必须与服务器一致 | `魔法箭`, `火球术`, `暴雪`, `混沌圣火` |
| 3 | **ManaCost** | int | 8-900 | 显示MP消耗,必须与服务器一致 | `8`, `27`, `170`, `200` |
| 4 | **ReqInt** | int | 0-500 | 显示智力需求,必须与服务器一致 | `18`, `26`, `195`, `180` |
| 5 | **Cost** | int | -1或正整数 | 学习费用,必须与服务器一致 | `-1`=不可学, `1`, `100` |
| 6 | Menu1 | int | 固定值 | 菜单位置X,通常固定填4 | `4` |
| 7 | Menu2 | int | 固定值 | 菜单位置Y,通常固定填5 | `5` |
| 8 | Menu3 | int | 固定值 | 菜单位置Z,通常固定填6 | `6` |
| 9 | Display | int | 0或1 | 是否显示 | `0`=隐藏, `1`=显示 |

**?? 重要提示**:
- 客户端的 ID, 名称, ManaCost, ReqInt, Cost 这5个字段必须与服务器Magic.cfg完全一致
- Menu1-3通常固定填 `4 5 6`
- Display通常填 `1` (显示)
- 如果服务器改了数值,客户端必须同步修改,否则显示错误

---

## 五、实际配置案例对照表

### 案例1: 魔法箭 (ID 0) - 最简单的单体魔法

**服务器配置**:
```properties
magic = 0   魔法箭  1  0  0  8  1  1  1 8 0  0 0 0  0 0 0  18  1  1  2
```

**客户端配置**:
```properties
magic = 0  魔法箭  8  18  1  4 5 6  1
```

**字段解析**:
| 字段 | 值 | 说明 |
|------|-----|------|
| Type | 1 | 单点伤害 |
| ManaCost | 8 | 只消耗8MP,初级魔法 |
| range2/3 | 1/1 | 虽填1但Type=1只打单体 |
| effect4-6 | 1/8/0 | 伤害1-8点,没有最大值 |
| effect7-9 | 0/0/0 | 无额外伤害,不随熟练度提升 |
| effect10-12 | 0/0/0 | 无特殊效果 |
| ReqInt | 18 | 18智力即可学习 |
| Attr | 2 | 魔法属性(蓝色能量) |

---

### 案例2: 火球术 (ID 20) - 典型的范围魔法

**服务器配置**:
```properties
magic = 20  火球术  3  0  0  27  2  2  2 6 2  2 6 2  0 0 0  26  1  1  3
```

**客户端配置**:
```properties
magic = 20  火球术  27  26  1  4 5 6  1
```

**字段解析**:
| 字段 | 值 | 说明 |
|------|-----|------|
| Type | 3 | 范围爆炸,一次性AOE |
| ManaCost | 27 | 消耗27MP |
| range2/3 | 2/2 | 5×5格范围 (2×2+1=5) |
| effect4-6 | 2/6/2 | 基础伤害2-6点 |
| effect7-9 | 2/6/2 | 熟练度100%额外+2-6伤害 |
| effect10-12 | 0/0/0 | 无特殊效果 |
| ReqInt | 26 | 26智力 |
| Attr | 3 | 火属性(红色火焰) |

---

### 案例3: 毒云 (ID 46) - 持续毒伤

**服务器配置**:
```properties
magic = 46  毒云  14  0  30  48  1  1  0 15 0  0 0 0  10 2 1  49  1  1  1
```

**客户端配置**:
```properties
magic = 46  毒云  48  49  1  4 5 6  1
```

**字段解析**:
| 字段 | 值 | 说明 |
|------|-----|------|
| Type | **14** | 毒云,持续毒伤范围 |
| Last | **30** | 持续30秒 |
| ManaCost | 48 | 消耗48MP |
| range2/3 | 1/1 | 3×3格范围 |
| effect4-6 | 0/15/0 | 每次15点毒伤 |
| effect7-9 | 0/0/0 | 无额外伤害 |
| effect10 | **10** | 持续10次伤害 |
| effect11 | **2** | 每2秒伤害一次 |
| effect12 | **1** | 毒云相关参数 |
| ReqInt | 49 | 49智力 |
| Attr | 1 | 毒属性(绿色毒雾) |

---

### 案例4: 流星攻击 (ID 81) - 多次伤害型

**服务器配置**:
```properties
magic = 81  流星攻击  21  0  0  120  2  2  6 8 12  7 12 18  0 0 0  169  1  1  3
```

**客户端配置**:
```properties
magic = 81  流星攻击  140  169  1  4 5 6  1
```

**字段解析**:
| 字段 | 值 | 说明 |
|------|-----|------|
| Type | **21** | 流星群攻,多次范围伤害 |
| ManaCost | 120 | 消耗120MP |
| range2/3 | 2/2 | 5×5格范围 |
| effect4-6 | 6/8/12 | 基础伤害6-12点 |
| effect7-9 | 7/12/18 | 熟练度100%额外+7-18伤害 |
| effect10-12 | 0/0/0 | 无特殊效果 |
| ReqInt | 169 | 169智力 |
| Attr | 3 | 火属性 |

**Type 21 vs Type 27 的区别**:
- **Type 21**: 多次独立伤害判定,每次都能打到不同目标
- **Type 27**: 持续范围伤害,在同一区域持续造成伤害+可能带禁锢

---

### 案例5: 暴雪 (ID 91) - 持续伤害型

**服务器配置**:
```properties
magic = 91  暴雪  27  0  0  170  3  3  6 5 21  7 8 20  20 0 0  200  100  1  4
```

**客户端配置**:
```properties
magic = 91  暴雪  170  195  100  4 5 6  1
```

**字段解析**:
| 字段 | 值 | 说明 |
|------|-----|------|
| Type | **27** | **持续多段伤害**(重点!) |
| ManaCost | 170 | 消耗170MP,高级魔法 |
| range2/3 | 3/3 | 7×7格超大范围 |
| effect4-6 | 6/5/21 | 基础伤害6-21点 |
| effect7-9 | 7/8/20 | 熟练度100%额外+7-20伤害 |
| effect10 | **20** | **禁锢20秒**(重点!) |
| effect11-12 | 0/0 | 未使用 |
| ReqInt | 200 | 200智力,高要求 |
| Cost | **100** | 学习费用100金币 |
| Attr | 4 | 冰属性(蓝白冰晶) |

---

### 案例6: 混沌圣火 (ID 97) - 自定义持续伤害

**服务器配置**:
```properties
magic = 97  混沌圣火  27  0  0  200  3  3  8 7 28  9 10 26  0 0 0  180  1  1  3
```

**客户端配置**:
```properties
magic = 97  混沌圣火  200  180  1  4 5 6  1
```

**字段解析**:
| 字段 | 值 | 说明 |
|------|-----|------|
| Type | **27** | 持续多段伤害(同暴雪) |
| ManaCost | 200 | 消耗200MP |
| range2/3 | 3/3 | 7×7格超大范围 |
| effect4-6 | 8/7/28 | 基础伤害8-28点,比暴雪高 |
| effect7-9 | 9/10/26 | 熟练度100%额外+9-26伤害 |
| effect10-12 | **0/0/0** | **无禁锢**(区别于暴雪) |
| ReqInt | 180 | 180智力 |
| Cost | 1 | 只需1金币学习 |
| Attr | **3** | **火属性**(区别于暴雪的冰属性) |

**对比暴雪的关键差异**:
| 对比项 | 暴雪(91) | 混沌圣火(97) |
|--------|---------|-------------|
| 伤害 | 6-21 (+7-20) | 8-28 (+9-26) ?更高 |
| 禁锢 | 20秒 | 无 ? |
| 属性 | 冰(4) | 火(3) ? |
| 学习费 | 100金 | 1金 ?便宜 |
| 智力 | 200 | 180 ?更低 |

---

### ? 实战配置总结表

| 魔法类型 | 推荐Type | 范围建议 | 伤害建议 | 典型案例 |
|---------|---------|---------|---------|---------|
| 单体快速 | 1 | 0/0 | 高伤 | 魔法箭 |
| 范围爆炸 | 3 | 1-2 | 中伤 | 火球术 |
| 持续控制 | 27 | 2-3 | 中高伤+effect10 | 暴雪 |
| 持续输出 | 27 | 2-3 | 中高伤+无控 | 混沌圣火 |
| 多次打击 | 21 | 2-3 | 中伤 | 流星攻击 |
| 毒伤DOT | 14 | 1-2 | 低伤+高频 | 毒云 |

---

## 六、常见配置问题解答

### Q1: 为什么我的魔法没有动画?
**A**: 客户端动画效果ID = 魔法ID + 100。比如魔法ID=97,需要在客户端代码中添加case 197的动画处理。

### Q2: Type 21和Type 27有什么区别?
**A**: 
- **Type 21**: 多次独立AOE,每次判定不同目标(流星雨)
- **Type 27**: 持续范围伤害,固定区域多次伤害(暴雪/混沌圣火)

### Q3: 如何让魔法带控制效果?
**A**: 使用Type=27 + effect10设置禁锢秒数,比如暴雪的effect10=20(禁锢20秒)

### Q4: 为什么我修改了配置文件没生效?
**A**: 
1. 服务器需要重启加载新的Magic.cfg
2. 客户端需要重启加载新的MAGICCFG.txt
3. 确认两个文件的ID/MP/智力完全一致

### Q5: 如何添加新魔法的图标?
**A**: 使用Pak编辑器打开`gldhall.pak`,找到sprite_0000,在Brush #[魔法ID]位置粘贴30×30的图标。

---

## 六、图标和动画资源配置

### ? 图标添加详细步骤

#### 准备工作:
1. **图标规格**: 30×30像素PNG图片,透明背景
2. **工具**: Pak编辑器 (HB Pak Editor)
3. **文件**: `New Client\SPRITES\gldhall.pak`

#### 操作步骤:

**步骤1**: 打开pak编辑器
```
文件 → 打开 → 选择 gldhall.pak
```

**步骤2**: 定位图标位置
- 双击 **sprite_0000** (魔法图标图集)
- 找到对应魔法ID的Brush
- 例如: ID 55 → 找到 **Brush #55**

**步骤3**: 查看图集坐标
| Brush ID | 在图集中的位置 | 坐标估算 |
|---------|--------------|---------|
| 0-9 | 第0行 | Y=0-31 |
| 10-19 | 第1行 | Y=32-63 |
| 50-59 | 第5行 | Y=160-191 |
| 90-99 | 第9行 | Y=288-319 |

**步骤4**: 粘贴图标
- 在对应位置粘贴你的30×30图标
- 确保位置对齐

**步骤5**: 保存
- 文件 → 保存
- 替换到游戏目录

---

### ? 动画效果配置

#### 方案A: 使用已有动画 (推荐?????)

**适用场景**: 不想修改客户端代码

**操作**:
1. 查找0-96中已有动画但不常用的魔法ID
2. 使用这个ID配置你的魔法
3. 自动继承该ID的动画效果

**示例**:
```properties
# 想要火球效果,使用ID 20 (火球术)
magic = 20  我的魔法  3  0  0  50  2  2  10 15 25  5 8 15  0 0 0  80  1  1  3
```

#### 方案B: 添加新动画 (高级)

**?? 需要**: C++编程基础,pak编辑技能

详细步骤参考本文档最后的"完整案例:混沌圣火"部分

---

## 七、Type魔法类型详解

### ?? Type 决定动画效果

**关键公式**: 客户端动画效果ID = **魔法ID + 100**

示例:
- 魔法ID 91 (暴雪) → 客户端效果ID **191**
- 魔法ID 97 (冰天雪地) → 客户端效果ID **197**

**注意**: 
- Type值影响伤害计算逻辑
- 但**动画效果由魔法ID决定**,与Type无关
- 如果客户端没有对应效果ID的代码/资源,**将无动画**

### 常用Type值

| Type | 效果类型 | 推荐度 | 说明 |
|------|---------|-------|------|
| 1 | 单体伤害 | ???? | 简单直接伤害 |
| 3 | 范围伤害 | ???? | AOE爆炸 |
| 21 | 流星群攻 | ????? | 多次范围打击 |
| 23 | 冰霜范围 | ???? | AOE+减速 |
| 27 | 暴雪/持续伤害 | ????? | 超大范围持续多段伤害 |
| 30 | 地震 | ???? | 超大范围震荡 |

**重要**: Type 27 会在施法区域内持续检测并造成多段伤害,适合制作持续输出型技能

### 属性 (Attr)

| Attr | 属性 | 效果 |
|------|------|------|
| 0 | 无属性 | 纯魔法伤害 |
| 3 | 火属性 | 火焰伤害 |
| 4 | 冰属性 | 冰霜伤害+减速 |
| 2 | 魔法属性 | 纯能量伤害 |

---

## 四、添加新魔法完整流程

### 步骤1: 服务器配置

编辑 `Magic.cfg`,添加:
```
magic = 97  冰天雪地  27  0  0  170  3  3  6 5 21  7 8 20  20 0 0  150  1  1  4
```

### 步骤2: 客户端配置

编辑 `MAGICCFG.txt`,添加:
```
magic = 97  冰天雪地  170  150  1  4 5 6  1
```

### 步骤3: 添加图标

**工具**: Pak编辑器

**文件**: `New Client\SPRITES\gldhall.pak`

**步骤**:
1. 打开pak文件,选择 sprite_0000 (魔法图标图集)
2. 找到 Brush #97 (对应魔法ID 97)
3. 在图集中对应位置添加/修改图标 (约30x30像素)
4. 保存pak文件

### 步骤4: 添加动画效果

**重要**: 客户端动画需要代码支持!

#### 方案A: 使用已有魔法ID (推荐?????)

选择0-96中不常用的魔法ID,直接修改其配置:
```
# 使用ID 47,自动继承其动画
magic = 47  冰天雪地  27  0  0  170  3  3  6 5 21  7 8 20  20 0 0  150  1  1  4
```

#### 方案B: 添加新ID动画 (需要修改客户端代码)

**如果一定要使用ID 97-99,需要:**

1. **添加effect pak资源**
   - 制作动画序列 (15帧PNG,透明背景)
   - 使用pak工具打包到现有pak文件

2. **修改客户端代码**

**2.1 确定资源位置**

查看 `Game.cpp` 第5477行,找到可用的pak空间:
```cpp
pGame->MakeEffectSpr("effect11s", 104, 18, FALSE); // 加载104-121
```

将新动画添加到 `effect11s.pak` 作为第19个sprite (索引18):
- 使用pak工具添加sprite到effect11s.pak
- **重要**: pak文件头偏移32处的sprite数量必须改为19!

**2.2 修改pak加载代码**

`Game.cpp` 第5499行:
```cpp
// 修改前
pGame->MakeEffectSpr("effect11s", 104, 18, FALSE);

// 修改后
pGame->MakeEffectSpr("effect11s", 104, 19, FALSE); // 18改为19
```

**2.3 添加主效果初始化**

`NotifyMsgHandler.cpp` 第42276行附近,添加:
```cpp
case 197: // 冰天雪地 (魔法ID 97)
    m_pEffectList[i]->m_cMaxFrame   = 14;  // 总帧数-1
    m_pEffectList[i]->m_dwFrameTime = 80;  // 每帧持续时间(ms)
    break;
```

**2.4 添加主效果循环**

`Game.cpp` 第18024行附近,添加:
```cpp
case 197: // 冰天雪地主效果
    if(m_pEffectList[i]->m_cFrame > m_pEffectList[i]->m_cMaxFrame)
    {
        delete m_pEffectList[i]; 
        m_pEffectList[i] = NULL; 
    }
    else
    {
        // 创建子效果(随机位置的冰雪)
        bAddNewEffect(75, m_pEffectList[i]->m_sX, m_pEffectList[i]->m_sY, 
                    m_pEffectList[i]->m_dX*32 +(rand()%140)-70, 
                    m_pEffectList[i]->m_dY*32 +(rand()%140)-70, 0); 
        
        // 播放音效
        sAbsX = abs(((m_sViewPointX / 32) + 10) - m_pEffectList[i]->m_dX); 
        sAbsY = abs(((m_sViewPointY / 32) + 7)  - m_pEffectList[i]->m_dY); 
        if(sAbsX > sAbsY) sDist = sAbsX; 
        else sDist = sAbsY; 
        lPan = -(((m_sViewPointX / 32) + 10) - m_pEffectList[i]->m_dX); 
        PlaySound('E', 1, sDist, lPan); 
    }
    break;
```

**2.5 添加子效果初始化**

`NotifyMsgHandler.cpp` 第41923行附近,添加:
```cpp
case 75: // 冰天雪地-飞舞的冰雪子效果
    m_pEffectList[i]->m_mX     = sX*32; 
    m_pEffectList[i]->m_mY     = sY*32; 
    m_pEffectList[i]->m_iErr   = 0; 
    m_pEffectList[i]->m_cMaxFrame   = 14;  // 与pak中Brush数量-1对应
    m_pEffectList[i]->m_dwFrameTime = 40; 
    break;
```

**2.6 添加子效果绘制**

`NotifyMsgHandler.cpp` 第42861行附近,添加:
```cpp
    cTempFrame = m_pEffectList[i]->m_cFrame; 
    if(cTempFrame < 0 || cTempFrame > 14) break; 
    dX  = (m_pEffectList[i]->m_mX)  - m_sViewPointX; 
    dY  = (m_pEffectList[i]->m_mY)  - m_sViewPointY; 
    m_pEffectSpr[122]->PutTransSprite_NoColorKey(dX, dY, cTempFrame, dwTime);
    break;
```

**2.7 编译和测试**

1. 编译客户端项目
2. 替换可执行文件
3. 进游戏测试动画显示

---

## 五、Pak文件格式说明

### Pak文件头结构

```
偏移0-31:  文件签名 "<New Pak Structure by ddgv>"
偏移32-35: sprite数量 (int, 小端序)
偏移36+:   sprite数据...
```

**重要**: 
- 使用pak编辑器添加sprite后,**必须确保偏移32处的值正确**
- sprite数量 = 实际sprite个数 (不是最大索引)
- 例如: sprite ID 0-18 (共19个) → 偏移32应写入 `13 00 00 00` (19的十六进制小端)

### 常见Pak文件错误

**问题**: `m_pEffectSpr[122] is NULL`

**原因**: pak文件头sprite数量错误

**检查方法**:
```powershell
$bytes = [System.IO.File]::ReadAllBytes("effect11s.pak")
$count = [BitConverter]::ToInt32($bytes, 32)
Write-Host "Sprite数量: $count"
```

**修复**方法:
- 使用支持的pak编辑器重新导出
- 或手动修改十六进制偏移32处的值

---

## 六、常见问题与排查

### 问题1: 技能无动画

**排查步骤**:
1. 检查 `Magic.cfg` 的 Type 值是否有效
2. 计算效果ID: `魔法ID + 100`
3. 确认客户端是否加载了对应effect资源
4. 查看 `Game.cpp` 的 `MakeEffectSpr` 加载列表
5. 验证pak文件是否存在且正确

**解决方案**:
- 方案A: 使用Type值在1-21范围
- 方案B: 添加pak资源和客户端代码

### 问题2: 技能图标不显示

**排查步骤**:
1. 打开 `gldhall.pak` 查看 Brush 列表
2. 确认对应魔法ID的 Brush 是否存在
3. 检查图集图片中对应位置是否有图标

**解决方案**:
- 在图集正确位置添加图标图片
- 保存pak文件并替换

### 问题3: 代码编译报错

**常见错误**:
```
error C2196: case value '197' already used
```

**原因**: case 197 已在其他地方定义

**解决**: 检查是否重复添加,删除重复的case

---

## 七、完整案例: 混沌圣火 (ID 97)

### 服务器配置
```properties
magic = 97  混沌圣火  27  0  0  200  3  3  8 7 28  9 10 26  0 0 0  180  1  1  3
```

**配置说明**:
- **Type=27**: 暴雪型持续多段伤害(DEF_MAGICTYPE_ICE_LINEAR)
- **range2=3, range3=3**: 3x3格范围(7x7格区域)
- **基础伤害**: 8-7-28 (高伤害)
- **额外伤害**: 9-10-26 (随熟练度提升)
- **effect10-12=0**: 无禁锢效果(暴雪是20,会禁锢)
- **Attr=3**: 火属性(暴雪是4冰属性)

### 客户端配置
```properties
magic = 97  混沌圣火  200  180  1  4 5 6  1
```

### 图标资源
- 文件: `gldhall.pak`
- Brush: #97
- 位置: (235, 292)
- 尺寸: 29x28

### 动画资源
- 文件: `effect11s.pak`
- Sprite: ID:0018 (第19个sprite)
- Brush数量: 14帧
- 图片尺寸: 565x381 (大型锥形特效)
- 帧率: 120ms/帧 (慢速度,1.68秒播完)
- effect索引: 122
- 动画数量: 2个火焰(第0帧和第7帧各1个)

### 客户端代码修改

**文件1: Game.cpp 第5499行**
```cpp
pGame->MakeEffectSpr("effect11s", 104, 19, FALSE); // 18改为19
```

**文件2: NotifyMsgHandler.cpp 第42276行**
```cpp
case 197: // 混沌圣火主效果(火系持续伤害)
    m_pEffectList[i]->m_cMaxFrame   = 13; // 14帧: 0-13
    m_pEffectList[i]->m_dwFrameTime = 80; // 主效果帧率80ms
    break;
```

**文件3: Game.cpp 第18024行**
```cpp
case 197: // 混沌圣火循环(火系多段伤害)
    if(m_pEffectList[i]->m_cFrame > m_pEffectList[i]->m_cMaxFrame)
    {
        delete m_pEffectList[i]; 
        m_pEffectList[i] = NULL; 
    }
    else
    {
        // 只在第0帧和第7帧创建火焰效果(共2个)
        if(m_pEffectList[i]->m_cFrame == 0 || m_pEffectList[i]->m_cFrame == 7)
        {
            bAddNewEffect(75, m_pEffectList[i]->m_sX, m_pEffectList[i]->m_sY, 
                        m_pEffectList[i]->m_dX*32 +(rand()%140)-70, 
                        m_pEffectList[i]->m_dY*32 +(rand()%140)-70, 0); 
            sAbsX = abs(((m_sViewPointX / 32) + 10) - m_pEffectList[i]->m_dX); 
            sAbsY = abs(((m_sViewPointY / 32) + 7)  - m_pEffectList[i]->m_dY); 
            if(sAbsX > sAbsY) sDist = sAbsX; 
            else sDist = sAbsY; 
            lPan = -(((m_sViewPointX / 32) + 10) - m_pEffectList[i]->m_dX); 
            PlaySound('E', 1, sDist, lPan); 
        }
    }
    break;
```

**文件4: NotifyMsgHandler.cpp 第41923行**
```cpp
case 75: // 混沌圣火子效果初始化
    m_pEffectList[i]->m_mX     = dX; // 使用像素坐标dX(不是grid坐标sX)
    m_pEffectList[i]->m_mY     = dY; // 使用像素坐标dY(不是grid坐标sY)
    m_pEffectList[i]->m_iErr   = 0; 
    m_pEffectList[i]->m_cMaxFrame   = 13; // 14帧: 0-13
    m_pEffectList[i]->m_dwFrameTime = 120; // 慢速度: 14帧×120ms=1.68秒
    break;
```

**文件5: NotifyMsgHandler.cpp 第42861行**
```cpp
case 75: // 混沌圣火绘制
    cTempFrame = m_pEffectList[i]->m_cFrame; 
    if(cTempFrame < 0 || cTempFrame > 13) break; // 14帧: 0-13
    dX  = (m_pEffectList[i]->m_mX)  - m_sViewPointX; 
    dY  = (m_pEffectList[i]->m_mY)  - m_sViewPointY; 
    // 减去图片宽高的一半(565/2=282, 381/2=190),使锥形底部中心对齐鼠标点击位置
    dX -= 282;
    dY -= 190;
    // 使用effect11s.pak扩展区域(添加到pak的第19个sprite,索引122)
    m_pEffectSpr[122]->PutTransSprite_NoColorKey(dX, dY, cTempFrame, dwTime);
    break;
```

### 关键点总结

1. **pak文件头**: 偏移32必须为19 (0x13)
2. **资源索引**: 第19个sprite对应索引122
3. **帧数**: 14个Brush → m_cMaxFrame = 13 (从0开始)
4. **效果ID**: 197 = 97 + 100
5. **子效果**: 75用于绘制飞舞的火焰
6. **位置对齐**: 减去(282, 190)使锥形底部中心对齐鼠标点击位置
7. **图片尺寸**: 565x381像素(大型锥形特效)
8. **帧率设置**: 主效果80ms/帧, 子效果120ms/帧(慢速度)
9. **动画数量**: 只在帧0和帧7创建,共2个火焰(避免视觉混乱)
10. **魔法类型**: Type=27 (持续多段伤害), Attr=3 (火属性)
11. **禁锢效果**: effect10-12=0 (无禁锢,区别于暴雪的20)
12. **坐标系统**: bAddNewEffect参数2,3是grid坐标,参数4,5是pixel坐标

---

## 八、更新记录

### 2025-11-19 v4.0
- **优化动画性能**: 从每帧创建改为只在帧0和帧7创建,共2个火焰
- **调整帧率**: 子效果帧率从50ms改为120ms,播放更流畅
- **火属性配置**: Type=27保持多段伤害,Attr=3改为火属性
- **移除禁锢**: effect10-12=0,去除暴雪的禁锢效果
- **位置修正**: 添加dX-282和dY-190偏移,使大图居中对齐
- **坐标系统说明**: 明确bAddNewEffect的grid坐标和pixel坐标区别

### 2025-11-18 v3.0
- **重构文档结构**: 分为8个主要章节,层次清晰
- **简化配置说明**: 突出核心字段,删除冗余内容
- **完善添加流程**: 详细记录冰天雪地完整实现过程
- **Pak格式说明**: 添加文件头结构和常见错误排查
- **完整案例**: 提供ID 97的端到端实现示例
- **删除过时内容**: 移除Type+100错误理解的遗留内容

### 核心发现
- ? 动画效果ID = **魔法ID + 100** (不是Type+100)
- ? Pak文件头偏移32存储sprite数量
- ? sprite数量必须等于实际个数(不是最大索引)
- ? 客户端需要5处代码修改才能显示新动画
- ? Type 27会自动产生持续多段伤害效果
- ? 大图特效需要减去宽高的一半实现居中对齐

---

## 附录A: 代码位置速查

| 功能 | 文件 | 行号范围 | 说明 |
|------|------|---------|------|
| 服务器发送效果 | NewPartySystem.cpp | 25329 | 发送(魔法ID+100) |
| 客户端接收效果 | Game.cpp | 6973 | 调用bAddNewEffect |
| 效果初始化 | NotifyMsgHandler.cpp | 41302+ | bAddNewEffect函数 |
| 效果循环更新 | Game.cpp | 18000+ | 主循环处理 |
| 效果绘制 | NotifyMsgHandler.cpp | 42363+ | DrawEffects函数 |
| 资源加载 | Game.cpp | 5477-5510 | MakeEffectSpr调用 |

## 附录B: 推荐开发工具

- **Pak编辑器**: HB Pak Editor
- **图像编辑**: Photoshop / GIMP
- **十六进制编辑**: HxD
- **代码编辑**: Visual Studio 6.0 / VS Code
- **版本控制**: Git