# 物品配置说明文档

## 概述

本文档详细说明物品配置文件 `Item.cfg`、`Item2.cfg`、`Item3.cfg`、`Item4.cfg` 的各项参数含义及配置方法。

### 配置文件读取位置

- **WorldServer**: [worldlog.cpp#L146-L149](WorldServer/worldlog.cpp#L146-L149) - 读取物品名称和ID映射
- **HGServer**: [Game.cpp#L10850-L11270](HGServer/Game.cpp#L10850) - 读取完整物品配置

---

## 配置文件格式

```
Item = ID 名称 类型 装备位置 EffectType EffectVal1 EffectVal2 EffectVal3 EffectVal4 EffectVal5 EffectVal6 EffectVal7 EffectVal8 最大耐用 特殊作用 模型ID 帧ID 售卖价格 重量 ApprValue 速度 等级限制 性别限制 特殊性能1 特殊性能2 相关技能 分类 物品颜色 稀有程度
```

---

## 参数详解

### 1. ID (物品唯一标识)
- **类型**: 整数
- **范围**: 1 - DEF_MAXITEMTYPES (通常为 1000+)
- **说明**: 每个物品的唯一编号，不能重复

### 2. 名称 (m_cName)
- **类型**: 字符串 (最大20字符)
- **说明**: 物品的内部名称，用于程序逻辑判断

### 3. 类型 (m_cItemType)
- **类型**: 整数
- **说明**: 决定物品的基本行为和**是否可叠加**

| 值 | 常量定义 | 说明 | 可叠加 |
|---|---------|------|-------|
| 0 | DEF_ITEMTYPE_NONE | 无类型 | ? |
| 1 | DEF_ITEMTYPE_EQUIP | 装备类 | ? |
| 2 | DEF_ITEMTYPE_APPLY | 应用类 | ? |
| 3 | DEF_ITEMTYPE_USE_DELETE | 使用后删除 | ? |
| 4 | DEF_ITEMTYPE_INSTALL | 安装类 | ? |
| **5** | **DEF_ITEMTYPE_CONSUME** | **消耗品** | ? |
| **6** | **DEF_ITEMTYPE_ARROW** | **箭矢** | ? |
| 7 | DEF_ITEMTYPE_EAT | 食物类 | ? |
| 8 | DEF_ITEMTYPE_USE_SKILL | 技能使用 | ? |
| 9 | DEF_ITEMTYPE_USE_PERM | 永久效果 | ? |
| 10 | DEF_ITEMTYPE_USE_SKILL_ENABLEDIALOGBOX | 技能(显示对话框) | ? |
| 11 | DEF_ITEMTYPE_USE_DEPLETE_DEST | 消耗目标 | ? |
| 12 | DEF_ITEMTYPE_MATERIAL | 材料类 | ? |
| 13 | DEF_ITEMTYPE_ADDBAG | 增加背包 | ? |
| 14 | DEF_ITEMTYPE_COUNTRYCHANGECARD | 转国卡 | ? |
| 15 | DEF_ITEMTYPE_BOSSSUMMONER | Boss召唤 | ? |
| 16 | DEF_ITEMTYPE_BAOSHI | 宝石类 | ? |
| 17 | DEF_ITEMTYPE_MARRYRING | 结婚戒指 | ? |
| 18 | DEF_ITEMTYPE_SUMMONPET | 召唤宠物 | ? |
| 19 | DEF_ITEMTYPE_PETRING | 宠物戒指 | ? |
| 20 | DEF_ITEMTYPE_PETNECKLACE | 宠物项链 | ? |
| 21 | DEF_ITEMTYPE_PETBAOZHU | 宠物宝珠 | ? |
| 22 | DEF_ITEMTYPE_GIFTBOX | 礼品盒 | ? |
| 23 | DEF_ITEMTYPE_GOODSBAG | 物品包 | ? |
| 24 | DEF_ITEMTYPE_ROSE | 玫瑰 | ? |
| 25 | DEF_ITEMTYPE_VIPTICKET | VIP券 | ? |
| 26 | DEF_ITEMTYPE_UPGRADESTONE | 升级石 | ? |
| 27 | DEF_ITEMTYPE_UPGRADELUCKITEM | 幸运升级物品 | ? |

### 4. 装备位置 (m_cEquipPos)
- **类型**: 整数
- **说明**: 物品可以装备的身体部位

| 值 | 常量定义 | 说明 |
|---|---------|------|
| 0 | DEF_EQUIPPOS_NONE | 不可装备 |
| 1 | DEF_EQUIPPOS_HEAD | 头部 |
| 2 | DEF_EQUIPPOS_BODY | 身体 |
| 3 | DEF_EQUIPPOS_ARMS | 手臂 |
| 4 | DEF_EQUIPPOS_LEGGINGS | 护腿 |
| 5 | DEF_EQUIPPOS_FEET | 脚部 |
| 6 | DEF_EQUIPPOS_NECK | 颈部 |
| 7 | DEF_EQUIPPOS_LHAND | 左手 |
| 8 | DEF_EQUIPPOS_RHAND | 右手 |
| 9 | DEF_EQUIPPOS_TWOHAND | 双手 |
| 10 | DEF_EQUIPPOS_RFINGER | 右手指 |
| 11 | DEF_EQUIPPOS_LFINGER | 左手指 |
| 12 | DEF_EQUIPPOS_BACK | 背部 |

### 5. 效果类型 (m_sItemEffectType)
- **类型**: 整数
- **说明**: 物品的效果类型

| 值 | 常量定义 | 说明 |
|---|---------|------|
| 0 | DEF_ITEMEFFECTTYPE_NONE | 无效果 |
| 1 | DEF_ITEMEFFECTTYPE_ATTACK | 攻击效果 |
| 2 | DEF_ITEMEFFECTTYPE_DEFENSE | 防御效果 |
| 3 | DEF_ITEMEFFECTTYPE_ATTACK_ARROW | 箭矢攻击 |
| 4 | DEF_ITEMEFFECTTYPE_HP | 恢复HP |
| 5 | DEF_ITEMEFFECTTYPE_MP | 恢复MP |
| 6 | DEF_ITEMEFFECTTYPE_SP | 恢复SP |
| 7 | DEF_ITEMEFFECTTYPE_HPSTOCK | HP储备 |
| 8 | DEF_ITEMEFFECTTYPE_GET | 获取效果 |
| 9 | DEF_ITEMEFFECTTYPE_STUDYSKILL | 学习技能 |
| 10 | DEF_ITEMEFFECTTYPE_SHOWLOCATION | 显示位置 |
| 11 | DEF_ITEMEFFECTTYPE_MAGIC | 魔法效果 |
| 12 | DEF_ITEMEFFECTTYPE_CHANGEATTR | 改变属性 |
| ... | ... | ... |

### 6-13. 效果值1-8 (m_sItemEffectValue1 ~ m_dwItemEffectValue8)
- **类型**: 整数/DWORD
- **说明**: 根据不同的效果类型有不同含义

#### 攻击类 (EffectType = 1):
- **EffectValue1**: 最小攻击骰子数 (D)
- **EffectValue2**: 最小攻击骰子面数
- **EffectValue3**: 最小攻击附加值
- **EffectValue4**: 最大攻击骰子数
- **EffectValue5**: 最大攻击骰子面数
- **EffectValue6**: 最大攻击附加值

#### HP/MP/SP恢复类:
- **EffectValue1**: 恢复骰子数
- **EffectValue2**: 恢复骰子面数
- **EffectValue3**: 恢复基础值

### 14. 最大耐久 (m_wMaxLifeSpan)
- **类型**: WORD (0-65535)
- **说明**: 物品的最大耐久度，0表示无限耐久

### 15. 特殊作用 (m_sSpecialEffect)
- **类型**: 整数
- **说明**: 物品的特殊效果标识

### 16-17. 模型ID和帧ID (m_sSprite, m_sSpriteFrame)
- **类型**: 整数
- **说明**: 客户端显示用的图形资源索引

### 18. 售卖价格 (m_wPrice)
- **类型**: 整数
- **说明**: 
  - 正数: 可出售，值为售价
  - 负数: 不可出售，取绝对值为参考价格

### 19. 重量 (m_wWeight)
- **类型**: WORD
- **说明**: 物品重量，影响负重计算

### 20. ApprValue (m_cApprValue)
- **类型**: char
- **说明**: 外观值，影响角色外观显示

### 21. 速度 (m_cSpeed)
- **类型**: char
- **说明**: 攻击/使用速度修正

### 22. 等级限制 (m_sLevelLimit)
- **类型**: short
- **说明**: 使用/装备所需最低等级，-1表示无限制

### 23. 性别限制 (m_cGenderLimit)
- **类型**: char
- **说明**: 
  - 0: 无限制
  - 1: 仅男性
  - 2: 仅女性

### 24-25. 特殊性能值 (m_sSpecialEffectValue1, m_sSpecialEffectValue2)
- **类型**: short
- **说明**: 命中率修正等特殊属性

### 26. 相关技能 (m_sRelatedSkill)
- **类型**: short
- **说明**: 使用该物品关联的技能ID，-1表示无关联

### 27. 分类 (m_cCategory)
- **类型**: char
- **说明**: 物品分类，用于背包整理和显示

### 28. 物品颜色 (m_cItemColor)
- **类型**: char
- **说明**: 物品显示颜色

### 29. 稀有程度 (m_iRareValue)
- **类型**: 整数 (取个位数)
- **说明**: 
  - 0: 普通物品
  - 1: 记录物品（记录击杀数据）
  - 2: 可特修物品
  - 3: 极品物品
  - 4: GM物品

---

## ? 物品叠加机制详解

### 叠加判断逻辑

物品是否可以叠加**完全由 `m_cItemType`（类型）字段决定**，相关代码在 [Game.cpp#L18895](HGServer/Game.cpp#L18895):

```cpp
if((pItem->m_cItemType == DEF_ITEMTYPE_CONSUME) || (pItem->m_cItemType == DEF_ITEMTYPE_ARROW))
{
    // 可叠加物品处理逻辑
    for(i = 0; i < m_pClientList[iClientH]->m_sBagSize; i++)
    {
        if((m_pClientList[iClientH]->m_pItemList[i] != NULL) && 
            (memNcmp(m_pClientList[iClientH]->m_pItemList[i]->m_cName, pItem->m_cName, 20) == 0))
        {
            // 相同名称的物品，数量叠加
            m_pClientList[iClientH]->m_pItemList[i]->m_dwCount += pItem->m_dwCount;
            *pDelReq = 1;  // 标记删除新物品对象
            iCalcTotalWeight(iClientH);
            return TRUE;
        }
    }
}
```

### 叠加条件

只有以下两种类型的物品可以叠加:

| 类型值 | 常量 | 说明 |
|-------|------|------|
| **5** | DEF_ITEMTYPE_CONSUME | 消耗品 |
| **6** | DEF_ITEMTYPE_ARROW | 箭矢 |

### 如何让物品可叠加

**方法：修改配置文件中的 `类型` 字段为 5 或 6**

#### 示例：让红药水可叠加（原本已是消耗品）
```
Item =   91              RedPotion   7   0   4   ...
                                     ^
                                     类型=7(EAT)，不可叠加

改为:
Item =   91              RedPotion   5   0   4   ...
                                     ^
                                     类型=5(CONSUME)，可叠加
```

### ?? 重要注意事项

1. **类型决定一切**: 物品叠加完全由类型字段控制，没有单独的"叠加数量上限"配置
2. **叠加无上限**: 代码中没有对叠加数量设置上限，理论上可以无限叠加
3. **同名叠加**: 叠加判断基于物品名称完全匹配
4. **修改风险**: 将装备类物品改为消耗品类型会导致物品无法装备和使用

### 不可通过配置修改叠加的物品类型

以下类型的物品如需叠加，必须修改代码：
- 装备类 (Type=1)
- 材料类 (Type=12)
- 宝石类 (Type=16)
- 其他非5/6的类型

### 代码修改方案（如需扩展叠加类型）

如果需要让更多类型的物品支持叠加，需要修改 [Game.cpp#L18895](HGServer/Game.cpp#L18895):

```cpp
// 原代码
if((pItem->m_cItemType == DEF_ITEMTYPE_CONSUME) || (pItem->m_cItemType == DEF_ITEMTYPE_ARROW))

// 修改为（示例：增加材料类可叠加）
if((pItem->m_cItemType == DEF_ITEMTYPE_CONSUME) || 
   (pItem->m_cItemType == DEF_ITEMTYPE_ARROW) ||
   (pItem->m_cItemType == DEF_ITEMTYPE_MATERIAL))
```

同时需要修改客户端 [HGClient/Game.cpp](HGClient/Game.cpp) 中的对应判断逻辑。

---

## 配置示例

### 示例1：配置一把单手剑

```
Item = 1000 TestSword 1 8 1 1 6 0 2 8 0 0 0 800 0 1 100 500 1500 5 10 0 0 0 7 1 1 0
```

参数解析:
- ID: 1000
- 名称: TestSword
- 类型: 1 (装备)
- 装备位置: 8 (右手)
- 效果类型: 1 (攻击)
- 攻击: 1D6+0 ~ 2D8+0
- 耐久: 800
- 价格: 500
- 重量: 1500
- 等级限制: 10

### 示例2：配置一个可叠加的消耗品

```
Item = 1001 SuperPotion 5 0 4 3 10 50 0 0 0 0 0 1 0 6 200 -100 10 -1 0 0 0 0 0 -1 21 0 0
```

参数解析:
- ID: 1001
- 名称: SuperPotion
- **类型: 5 (消耗品，可叠加)**
- 装备位置: 0 (不可装备)
- 效果类型: 4 (恢复HP)
- 恢复: 3D10+50 HP
- 耐久: 1 (消耗品通常为1)
- 价格: -100 (不可出售)
- 无等级限制

### 示例3：配置可叠加的箭矢

```
Item = 1002 FireArrow 6 0 0 1 8 5 1 8 5 0 0 1 0 6 15 5 20 1 5 0 0 0 0 4 0 0
```

参数解析:
- ID: 1002
- 名称: FireArrow
- **类型: 6 (箭矢，可叠加)**
- 攻击: 1D8+5
- 价格: 5
- 等级限制: 5

---

## 配置文件位置

- 服务端: `Server/Item.cfg`, `Server/Item2.cfg`, `Server/Item3.cfg`, `Server/Item4.cfg`
- 客户端会从服务端同步配置

---

## 相关源文件

| 文件 | 功能 |
|-----|------|
| [HGServer/Item.h](HGServer/Item.h) | CItem类定义和常量定义 |
| [HGServer/Game.cpp](HGServer/Game.cpp) | 物品配置读取和物品添加逻辑 |
| [WorldServer/worldlog.cpp](WorldServer/worldlog.cpp) | WorldServer物品配置读取 |
| [HGClient/Game.cpp](HGClient/Game.cpp) | 客户端物品处理逻辑 |

---

## 总结

**物品叠加可以通过配置更改吗？**

? **可以**，但有限制：
- 只需要将物品的 `类型` 字段设置为 `5`(消耗品) 或 `6`(箭矢) 即可实现叠加
- 叠加数量没有配置限制，理论上无上限
- 叠加判断基于物品名称完全匹配

? **不可以**的情况：
- 如果想让装备类保持装备功能的同时支持叠加，必须修改代码
- 如果想给叠加设置数量上限，必须修改代码
- 如果想让其他类型（如材料类）支持叠加，必须修改代码中的类型判断逻辑
