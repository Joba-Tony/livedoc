# 天使榜血量加成说明

## 功能概述

天使等级榜前10名的玩家会获得**血量百分比加成**，不需要任何称号，登录或刷新属性时自动生效。

---

## 加成数值表

根据配置文件 `RandomDrop.cfg` 中的 `AngelRatio` 设置：

| 排名 | 数组索引 | 配置值 | 实际效果 |
|------|---------|--------|---------|
| **第1名** | 0 | 15 | 血量上限 +15% |
| **第2名** | 1 | 13 | 血量上限 +13% |
| **第3名** | 2 | 12 | 血量上限 +12% |
| **第4名** | 3 | 10 | 血量上限 +10% |
| **第5名** | 4 | 9 | 血量上限 +9% |
| **第6名** | 5 | 7 | 血量上限 +7% |
| **第7名** | 6 | 5 | 血量上限 +5% |
| **第8名** | 7 | 3 | 血量上限 +3% |
| **第9名** | 8 | 2 | 血量上限 +2% |
| **第10名** | 9 | 1 | 血量上限 +1% |

---

## 计算公式

### 基础血量的计算

天使榜加成是基于**纯属性基础血量**计算的，**不包括**装备、技能、其他榜单等额外加成。

**基础血量公式**：
```
基础血量 = 魅力×1 + 体质×3 + 等级×2 + 力量÷2 + 盾牌技能×4 + 长盾技能×4
```
> 注：魅力超过20时，魅力不计入血量

### 天使榜加血计算

```
实际加血量 = 基础血量 × 配置百分比值 / 100
最终血量上限 = 基础血量 + 实际加血量 + 其他加成(装备/技能等)
```

### 计算示例

假设玩家属性：
- 等级180，体质300，力量100，魅力10
- 盾牌技能120，长盾技能0

**步骤1：计算基础血量**
```
基础血量 = 10×1 + 300×3 + 180×2 + 100÷2 + 120×4 + 0×4
        = 10 + 900 + 360 + 50 + 480
        = 1800
```

**步骤2：计算天使榜加成**（假设第1名，配置15%）
```
实际加血量 = 1800 × 15 / 100 = 270
```

### ?? 常见误解

**玩家可能看到的"总血量"** ≠ **基础血量**

玩家在客户端看到的血量上限可能是2500，但这包含了：
- 基础血量：1800
- 装备加成：+300
- 其他榜单加成：+200
- 丹心石加成：+200

如果按2500计算15%，会得到375点，但实际只会得到270点（1800×15%）。

**这不是bug，是设计如此**――天使榜加成只基于纯属性基础血量计算。

---

## 配置修改方法

### 配置文件位置
`GameConfigs\RandomDrop.cfg`

### 配置格式
```ini
AngelRatio = 15 13 12 10 9 7 5 3 2 1
```

- 10个数值，用空格分隔
- 从左到右依次对应第1名到第10名
- 数值单位为**百分比**（15 表示 15%）

### 修改示例

如果想把第1名的加成改为20%，第2名改为18%：
```ini
AngelRatio = 20 18 12 10 9 7 5 3 2 1
```

**注意**：修改配置文件后需要**重启服务器**才能生效。

---

## 排名规则

天使榜排名依据：
1. **天使等级**：等级高的排在前面
2. **天使经验**：等级相同时，经验高的排在前面

排名更新时机：
- 玩家登录时
- 玩家天使等级/经验变化时

---

## 常见问题

### Q1: 为什么我的血量加成比之前少了？

**A**: 2025年12月27日修复了一个索引错误的bug。

**之前的bug**：排名索引错位，导致：
- 第2名实际使用第1名的配置值（15%而不是13%）
- 第3名实际使用第2名的配置值（13%而不是12%）
- ...以此类推

**修复后**：每个名次使用正确对应的配置值。

所以如果你是第2名及以后的玩家，修复后血量加成会"变少"，但这是**正确的行为**。

### Q2: 第1名之前为什么没有加成？

**A**: 之前的bug导致第1名的索引计算为 -1（无效），所以第1名完全没有血量加成。现在已修复。

### Q3: 加成是固定值还是百分比？

**A**: 是**百分比加成**，但是基于**纯属性基础血量**计算，不是基于你看到的总血量。

### Q3.1: 为什么我算出来的加成和实际不一样？

**A**: 你可能用错了基础值。

**错误计算**：用客户端显示的总血量 × 百分比
**正确计算**：用纯属性基础血量 × 百分比

**基础血量公式**：
```
基础血量 = 魅力×1 + 体质×3 + 等级×2 + 力量÷2 + 盾牌技能×4 + 长盾技能×4
```

**验证方法**：用实际加的血量 ÷ 百分比，可以反推出你的基础血量。

例如：
- 第7名加了50点血，配置5%，基础血量 = 50 ÷ 0.05 = **1000**
- 第1名加了180点血，配置15%，基础血量 = 180 ÷ 0.15 = **1200**

### Q4: 什么时候生效？

**A**: 
- 登录时立即生效
- 排名变化时，下次属性刷新时生效
- 客户端会显示消息："你的生命值上限提高了:X." 或 "你的生命值上限降低了:X."

### Q5: 需要称号吗？

**A**: **不需要**。天使榜加成是独立的，只要在榜上就有加成，不需要选择显示称号。

---

## 技术细节（开发参考）

### 相关变量
- `m_fAngelScore[10]`：存储10个名次的加成百分比值
- `m_angelScoreIndex`：玩家的天使榜排名索引（0-9有效，100表示不在榜上）

### 代码位置
- 配置读取：[NewPartySystem.cpp#L16064](HGServer/NewPartySystem.cpp#L16064)
- 排名更新：[Game.cpp#L2495](HGServer/Game.cpp#L2495)
- 加成计算：[Game.cpp#L43937-L43940](HGServer/Game.cpp#L43937)
- 转换为实际HP值：[Game.cpp#L43972](HGServer/Game.cpp#L43972)

### 计算流程
1. 玩家登录时，调用 `UpdateAngelScore` 获取排名（返回0-9或-1）
2. 将排名存入 `m_angelScoreIndex`
3. 属性计算时，读取 `m_fAngelScore[m_angelScoreIndex]` 获取百分比值
4. 加到 `sNewHPAdded` 变量中
5. 最后统一转换：`sNewHPAdded = 基础HP × sNewHPAdded / 100`

---

*文档创建时间：2025年12月28日*
