# 魔法系统配置指南

> **基于实际代码的配置速查手册**  
> 包含6个真实魔法案例 + 完整字段解析 + 常见问题解答

---

## 一、配置文件位置

### 服务器端
- **路径**: `Server\WorldServer\Magic.cfg`
- **作用**: 魔法伤害、消耗、范围等游戏逻辑
- **重启**: 修改后需重启服务器

### 客户端
- **路径**: `New Client\CONTENTS\MAGICCFG.txt`
- **作用**: 魔法UI显示、学习费用
- **重启**: 修改后需重启客户端

---

## 二、服务器配置字段详解 (Magic.cfg)

### 完整字段表 (21个字段)

| 序号 | 字段名 | 类型 | 实际范围 | 说明 | 实例 |
|------|--------|------|---------|------|------|
| 1 | ID | int | 0-99 | 魔法ID | `0`, `20`, `91`, `97` |
| 2 | 名称 | string | 中文 | 魔法名称 | `魔法箭`, `火球术`, `暴雪` |
| 3 | **Type** | int | 1-32 | 魔法类型,决定伤害机制 | `1`=单体, `3`=范围, `27`=持续 |
| 4 | Delay | int | 0-1000 | 施法延迟(毫秒),通常为0 | `0` |
| 5 | Last | int | 0-180 | 持续时间(秒),0=瞬发 | `0`, `30`, `60` |
| 6 | **ManaCost** | int | 8-900 | MP消耗 | `8`, `27`, `170`, `200` |
| 7 | **range2** | int | 0-4 | X轴范围半径 | `0`=单点, `1`=3×3, `2`=5×5, `3`=7×7 |
| 8 | **range3** | int | 0-4 | Y轴范围半径,通常与range2相同 | 同range2 |
| 9 | **effect4** | int | 0-50 | 基础最小伤害 | `1`, `6`, `8` |
| 10 | **effect5** | int | 0-100 | 基础平均伤害 | `8`, `7`, `5` |
| 11 | **effect6** | int | 0-150 | 基础最大伤害 | `0`, `21`, `28` |
| 12 | **effect7** | int | 0-50 | 额外最小伤害(熟练度) | `0`, `7`, `9` |
| 13 | **effect8** | int | 0-80 | 额外平均伤害(熟练度) | `0`, `8`, `10` |
| 14 | **effect9** | int | 0-120 | 额外最大伤害(熟练度) | `0`, `20`, `26` |
| 15 | **effect10** | int | 0-100 | **特殊参数1** 根据Type不同含义不同 | 见下方详细说明 |
| 16 | **effect11** | int | 0-10 | **特殊参数2** 根据Type不同含义不同 | 见下方详细说明 |
| 17 | **effect12** | int | 0-100 | **特殊参数3** 根据Type不同含义不同 | 见下方详细说明 |
| 18 | **ReqInt** | int | 0-500 | 学习所需智力 | `18`, `26`, `200`, `180` |
| 19 | Cost | int | -1/正数 | 学习费用(金币) | `-1`=不可学, `1`, `100` |
| 20 | Caty | int | 0/1 | 魔法类别 | `0`=辅助, `1`=攻击 |
| 21 | **Attr** | int | 0-4 | 魔法属性 | `0`=无, `1`=毒, `2`=魔法, `3`=火, `4`=冰 |

### ? 核心字段快速参考

#### ? 伤害系统详解

**?? 关键理解**: 每次施法,游戏会**随机**从三个伤害值中选一个!

```
实际伤害 = 随机选择(effect4, effect5, effect6) + 对应额外伤害 × (熟练度/100)
```

##### 三个伤害值的含义

```properties
magic = 50  火球术  3  0  0  30  2  2  10 15 25  5 8 15  0 0 0  50  1  1  3
                                      ^^^^^^^^  ^^^^^^^
                                      基础伤害   额外伤害
```

**基础伤害 (effect4, effect5, effect6)** - 游戏会随机选一个:
- **effect4**: 10 → **低伤值** (约33%概率打出)
- **effect5**: 15 → **中伤值** (约33%概率打出)  
- **effect6**: 25 → **高伤值** (约33%概率打出)

**额外伤害 (effect7, effect8, effect9)** - 对应基础伤害:
- **effect7**: 5 → 如果随机到effect4,熟练度100%时额外+5
- **effect8**: 8 → 如果随机到effect5,熟练度100%时额外+8
- **effect9**: 15 → 如果随机到effect6,熟练度100%时额外+15

##### 实战举例

**新手玩家 (熟练度0%)**:
- 随机出低伤: **10**点
- 随机出中伤: **15**点  
- 随机出高伤: **25**点
- **伤害波动**: 10~25

**熟练玩家 (熟练度50%)**:
- 随机出低伤: 10 + 5×50% = **12.5**点
- 随机出中伤: 15 + 8×50% = **19**点
- 随机出高伤: 25 + 15×50% = **32.5**点
- **伤害波动**: 12~33

**大师玩家 (熟练度100%)**:
- 随机出低伤: 10 + 5 = **15**点
- 随机出中伤: 15 + 8 = **23**点
- 随机出高伤: 25 + 15 = **40**点
- **伤害波动**: 15~40

##### ? 如何配置三个伤害值?

**方法1: 稳定输出型** (伤害稳定,适合PVE)
```properties
effect4=10, effect5=12, effect6=15  →  伤害10~15,波动小
```

**方法2: 暴击型** (高风险高回报,适合PVP)
```properties
effect4=5, effect5=10, effect6=30  →  通常5~10,偶尔暴击30!
```

**方法3: 均衡型** (最常见)
```properties
effect4=10, effect5=15, effect6=25  →  10/15/25三档伤害
```

##### ? 实际配置对比

| 魔法 | effect4/5/6 | 风格 | 说明 |
|------|------------|------|------|
| 魔法箭(0) | 1/8/0 | 异常配置 | 低1,中8,高0(高伤是0!) |
| 火球术(20) | 2/6/2 | 错误配置 | 低2,中6,高2(高伤应>中伤) |
| 暴雪(91) | 6/5/21 | 暴击型 | 低6,中5,高21(大暴击3.5倍) |
| 混沌圣火(97) | 8/7/28 | 超暴击型 | 低8,中7,高28(超大暴击4倍) |
| 流星攻击(81) | 6/8/12 | 稳定型 | 低6,中8,高12(波动小) |

**?? 配置建议**:
1. **推荐**: effect4 ≤ effect5 ≤ effect6 (从小到大递增)
2. **推荐**: effect6 = effect4 × 2~4 (制造暴击感)
3. **推荐**: effect7 ≤ effect8 ≤ effect9 (额外伤害也递增)
4. **避免**: 三个值完全相同(失去随机性,太无聊)
5. **避免**: effect6 = 0 (会出现0伤害!)

#### 范围计算
```
实际范围 = (range2×2+1) × (range3×2+1) 格
```

**可视化示意图** (★ = 施法中心点):

**range2/3 = 0** (1×1 单点)
```
★
```

**range2/3 = 1** (3×3 小范围,9格)
```
□ □ □
□ ★ □
□ □ □
```

**range2/3 = 2** (5×5 中范围,25格)
```
□ □ □ □ □
□ □ □ □ □
□ □ ★ □ □
□ □ □ □ □
□ □ □ □ □
```

**range2/3 = 3** (7×7 大范围,49格) - 暴雪/混沌圣火使用此范围
```
□ □ □ □ □ □ □
□ □ □ □ □ □ □
□ □ □ □ □ □ □
□ □ □ ★ □ □ □
□ □ □ □ □ □ □
□ □ □ □ □ □ □
□ □ □ □ □ □ □
```

**range2/3 = 4** (9×9 超大范围,81格)
```
□ □ □ □ □ □ □ □ □
□ □ □ □ □ □ □ □ □
□ □ □ □ □ □ □ □ □
□ □ □ □ □ □ □ □ □
□ □ □ □ ★ □ □ □ □
□ □ □ □ □ □ □ □ □
□ □ □ □ □ □ □ □ □
□ □ □ □ □ □ □ □ □
□ □ □ □ □ □ □ □ □
```

| range2/3 | 实际范围 | 视觉效果 | 典型魔法 |
|---------|---------|---------|---------|
| 0 | 1×1 | 单点 | 魔法箭 |
| 1 | 3×3 (9格) | 小范围 | 毒云 |
| 2 | 5×5 (25格) | 中范围 | 火球术, 流星攻击 |
| 3 | 7×7 (49格) | 大范围 | 暴雪, 混沌圣火 |
| 4 | 9×9 (81格) | 超大范围 | 地震 |

**? 提示**: 
- 范围越大,MP消耗越高
- 大范围魔法(range≥3)建议智力需求≥150
- Type=1(单点伤害)无视range设置,始终只打一个目标

#### Type类型速查 (常用)

| Type | 名称 | 效果 | 实例 |
|------|------|------|------|
| **1** | 单点伤害 | 只打1个目标,无路径 | 魔法箭(0), 雷击术(43) |
| **3** | 范围爆炸 | 范围一次性伤害 | 火球术(20) |
| **14** | 毒云 | 持续毒伤 | 毒云(46) |
| **21** | 范围无路径 | 直接对目标区域造成伤害,无路径 | 魔能冲击(60), 神之怒(74), 魔法飞弹(82) |
| **27** | 冰系直线 | 沿路径持续多段伤害,有路径 | 暴雪(91) |
| **30** | 地震 | 范围震荡 | 地震(96) |
| **34** | 终极冰系 | 多波次范围伤害,100%冰冻 | 寒箭埋骨(97) |
| **35** | 冰封领域 | 屏幕范围多波伤害,只对NPC | 冰封领域(98) |

#### Attr属性速查

| Attr | 属性 | 视觉效果 | 实例 |
|------|------|---------|------|
| **0** | 无属性 | 白/紫光 | 魔法弹(10) |
| **1** | 毒属性 | 绿色毒雾 | 毒云(46) |
| **2** | 魔法属性 | 蓝色能量 | 魔法箭(0) |
| **3** | 火属性 | 红/橙火焰 | 火球术(20), 混沌圣火(97) |
| **4** | 冰属性 | 蓝/白冰晶 | 暴雪(91) |

---

### ? effect10/11/12 特殊参数详解 (基于源码分析)

这三个字段的含义**完全取决于魔法的 Type 类型**,不同类型有完全不同的用途。

#### ? 完整对照表 (按 Type 分类)

| Type | 类型名称 | effect10 含义 | effect11 含义 | effect12 含义 | 代码位置 |
|------|---------|--------------|--------------|--------------|---------|
| **14** | 毒云/火墙 | **动态对象类型ID** | **形状类型** | **范围半径/长度** | NewPartySystem.cpp:24740 |
| | | 1=火墙, 8=冰风暴, 9=地刺, 10=毒云 | 1=墙型, 2=区域型 | 墙型时=长度, 区域型时=半径 | |
| **21** | 范围无路径 | 未使用(填0) | 未使用(填0) | 未使用(填0) | NewPartySystem.cpp:24316 |
| | (魔能冲击) | 直接范围伤害,无特殊效果 | | | |
| **23** | 冰系魔法 | **禁锢秒数** | 未使用(填0) | 未使用(填0) | NewPartySystem.cpp:23546 |
| | (冰风系) | 被冰冻的持续时间(秒) | | | |
| **26** | 破甲魔法 | **特殊伤害参数** | 未使用(填0) | 未使用(填0) | NewPartySystem.cpp:25148 |
| | (暗黑之云) | 装甲耐久度损失值 | | | |
| **27** | 冰系直线 | **禁锢秒数** | 未使用(填0) | 未使用(填0) | NewPartySystem.cpp:23546 |
| | (暴雪) | 被冰冻的持续时间(秒) | | | |
| **30** | 地震魔法 | **破甲数值** | 未使用(填0) | 未使用(填0) | NewPartySystem.cpp:22380 |
| | | 装甲耐久度损失值 | | | |
| **34** | 终极冰系 | **冰冻秒数** | **每波命中次数** | **总波数** | NewPartySystem.cpp:25674 |
| | (寒箭埋骨) | 冰冻持续时间(秒) | 每波对目标命中几次 | 总共多少波伤害 | |
| **35** | 冰封领域 | **冰冻秒数** | **每波命中次数** | **总波数** | NewPartySystem.cpp:25774 |
| | | 冰冻持续时间(秒) | 每波对目标命中几次 | 总共多少波伤害 | |
| **36** | 群体魔法 | 未使用(填0) | 未使用(填0) | **实际魔法ID** | NewPartySystem.cpp:23112 |
| | | | | 对队友释放的魔法ID | |
| **其他** | 通用魔法 | 未使用(填0) | 未使用(填0) | 未使用(填0) | - |

---

#### ? 详细说明

##### 1?? Type 14 (毒云/火墙) - 创建动态伤害区域

**effect10**: 动态对象类型ID (必填)
```cpp
// 源码定义 (DynamicObjectID.h)
1  = DEF_DYNAMICOBJECT_FIRE          // 火墙
8  = DEF_DYNAMICOBJECT_ICESTORM      // 冰风暴
9  = DEF_DYNAMICOBJECT_SPIKE         // 地刺陷阱
10 = DEF_DYNAMICOBJECT_PCLOUD_BEGIN  // 毒云开始
11 = DEF_DYNAMICOBJECT_PCLOUD_LOOP   // 毒云循环
12 = DEF_DYNAMICOBJECT_PCLOUD_END    // 毒云结束
13 = DEF_DYNAMICOBJECT_FIRE2         // 火墙2
14 = DEF_DYNAMICOBJECT_FIRE3         // 火墙3
```

**effect11**: 形状类型 (必填)
```cpp
1 = 墙型 (Wall Type)     // 从施法者向目标点延伸的直线墙体
2 = 区域型 (Field Type)   // 以目标点为中心的方形区域
```

**effect12**: 范围参数 (必填)
- **墙型 (effect11=1)**: 墙体两侧延伸的格子数
  - `effect12=1` → 墙长度为 1+1*2=3格 (中心+两侧各1格)
  - `effect12=2` → 墙长度为 1+2*2=5格 (中心+两侧各2格)
- **区域型 (effect11=2)**: 以目标点为中心的正方形半径
  - `effect12=1` → 3×3 区域 (中心±1格)
  - `effect12=2` → 5×5 区域 (中心±2格)

**实际案例**:
```properties
# 烈焰之牢(40) - 墙型火墙
effect10 = 1   // 火墙对象
effect11 = 1   // 墙型
effect12 = 2   // 两侧各延伸2格

# 怒火燎原(41) - 墙型火墙
effect10 = 1   // 火墙对象
effect11 = 2   // 区域型
effect12 = 1   // 3×3区域

# 毒云(46) - 区域型毒云
effect10 = 10  // 毒云对象
effect11 = 2   // 区域型
effect12 = 1   // 3×3区域

# 魔之陷(54) - 区域型地刺
effect10 = 9   // 地刺对象
effect11 = 2   // 区域型
effect12 = 2   // 5×5区域
```

---

##### 2?? Type 23/27 (冰系魔法/冰系直线) - 禁锢效果

**effect10**: 禁锢持续时间(秒) (可选, 0=无禁锢)

```cpp
// 源码实现 (NewPartySystem.cpp:23546)
bRegisterDelayEvent(DEF_DELAYEVENTTYPE_MAGICRELEASE, DEF_MAGICTYPE_ICE, 
    dwTime + (m_pMagicConfigList[sType]->m_sValue10 * 1000),  // 转换为毫秒
    sOwnerH, cOwnerType, ...);
```

**effect11/12**: 未使用,填 `0`

**实际案例**:
```properties
# 冰风之吻(45) - Type 23
effect10 = 5   // 禁锢5秒
effect11 = 0   // 未使用
effect12 = 0   // 未使用

# 暴雪(91) - Type 27
effect10 = 20  // 禁锢20秒!
effect11 = 0   // 未使用
effect12 = 0   // 未使用

# 寒箭埋骨(97) - Type 34 (终极冰系魔法)
effect10 = 20  // 冰冻持续时间(秒)
effect11 = 3   // 每波命中次数
effect12 = 4   // 总波数
```

**禁锢效果**: 目标被冰冻,无法移动、攻击、施法,持续 `effect10` 秒。

---

##### 3?? Type 30 (地震) - 破甲伤害

**effect10**: 装甲耐久度损失值 (必填)

```cpp
// 源码实现 (NewPartySystem.cpp:22380)
ArmorLifeDecrement(iClientH, sOwnerH, cOwnerType, 
    m_pMagicConfigList[sType]->m_sValue10);  // 减少装甲耐久度
```

**effect11/12**: 未使用,填 `0`

**实际案例**:
```properties
# 地震(96) - Type 30
effect10 = 26  // 破甲26点耐久度
effect11 = 0   // 未使用
effect12 = 0   // 未使用
```

**破甲效果**: 除了造成伤害外,还会降低目标装备的耐久度。

---

##### 4?? Type 26 (暗黑之云) - 装甲损伤

**effect10**: 装甲耐久度损失值 (必填)

```cpp
// 源码实现 (NewPartySystem.cpp:25148)
ArmorLifeDecrement(iClientH, sOwnerH, cOwnerType, 
    m_pMagicConfigList[sType]->m_sValue10);
```

**effect11/12**: 未使用,填 `0`

**实际案例**:
```properties
# 暗黑之云(66) - Type 26
effect10 = 15  // 装甲损失15点耐久
effect11 = 0   // 未使用
effect12 = 0   // 未使用
```

---

##### 5?? Type 36 (群体魔法) - 队友魔法转发

**effect12**: 对队友实际释放的魔法ID (必填)

```cpp
// 源码实现 (NewPartySystem.cpp:23112)
int iMagic = m_pMagicConfigList[sType]->m_sValue12;
PlayerMagicHandler(iClientH, ..., iMagic, TRUE);  // 对自己释放
// 然后对所有队友也释放相同魔法
```

**effect10/11**: 未使用,填 `0`

**实际案例** (注释掉的配置):
```properties
# 群体治愈(84) - Type 36
effect10 = 0   // 未使用
effect11 = 0   // 未使用
effect12 = 21  // 对队友释放魔法21(圣疗之光)

# 群体魔结界(85) - Type 36
effect12 = 33  // 对队友释放魔法33(魔结界)

# 群体狂暴(86) - Type 36
effect12 = 50  // 对队友释放魔法50(狂暴攻击)
```

**群体魔法原理**: 自己和队友范围内的所有成员,都会被施加 `effect12` 指定的魔法效果。

---

#### ? 配置指南

**推荐填写规则**:

1. **Type 14 (毒云/火墙)**:
   - 必填三个参数: effect10=对象ID, effect11=形状, effect12=范围
   - 墙型推荐: `effect10=1, effect11=1, effect12=2` (5格火墙)
   - 区域型推荐: `effect10=10, effect11=2, effect12=1` (3×3毒云)

2. **Type 21 (范围无路径)**:
   - 三个参数全填 `0`
   - 直接对目标区域造成伤害，无路径轨迹
   - 适合需要瞬发范围AOE的技能

3. **Type 23/27 (冰系魔法)**:
   - 如果要禁锢: `effect10=5~20` (禁锢5-20秒)
   - 如果不要禁锢: `effect10=0` (纯伤害魔法)
   - effect11/12 固定填 `0`

4. **Type 30 (地震)**:
   - 必填破甲值: `effect10=20~30` (破甲20-30点)
   - effect11/12 固定填 `0`

5. **Type 34 (终极冰系-寒箭埋骨)**:
   - `effect10` = 冰冻持续秒数 (推荐10~20)
   - `effect11` = 每波命中次数 (推荐2~4)
   - `effect12` = 总波数 (推荐3~5)
   - **特点**: 第一波不检查魔抗(必中),后续波次检查魔抗

6. **Type 35 (冰封领域)**:
   - `effect10` = 冰冻持续秒数
   - `effect11` = 每波命中次数
   - `effect12` = 总波数
   - **特点**: 只对NPC有效,以施法者为中心

7. **Type 36 (群体魔法)**:
   - 必填目标魔法: `effect12=21/33/50/65` (对应单体魔法ID)
   - effect10/11 固定填 `0`

8. **其他所有 Type**:
   - 三个参数全填 `0`

---

#### ⚠️ 常见错误

1. **Type 14 忘记填 effect11/12** → 动态对象无法正确创建
2. **Type 27 想要纯伤害但 effect10>0** → 意外产生禁锢效果
3. **非 Type 14 随意填写 effect10/11/12** → 可能产生未知效果
4. **混淆 Type 23 和 Type 27** → 两者都支持禁锢,但伤害机制不同
5. **Type 34/35 的 effect11/12 填0** → 会使用默认值(每波2次,共3波)
6. **混淆 Type 27 和 Type 34** → Type 27是路径伤害,Type 34是固定波次

---

## 三、客户端配置字段详解 (MAGICCFG.txt)

### 完整字段表 (9个字段)

| 序号 | 字段名 | 类型 | 范围 | 说明 | 实例 |
|------|--------|------|------|------|------|
| 1 | **ID** | int | 0-99 | 必须与服务器一致 | `0`, `20`, `97` |
| 2 | **名称** | string | 中文 | 必须与服务器一致 | `魔法箭`, `火球术` |
| 3 | **ManaCost** | int | 8-900 | 必须与服务器一致 | `8`, `27`, `200` |
| 4 | **ReqInt** | int | 0-500 | 必须与服务器一致 | `18`, `26`, `180` |
| 5 | **Cost** | int | -1/正数 | 必须与服务器一致 | `-1`, `1`, `100` |
| 6 | Menu1 | int | 固定 | 菜单位置X,通常填4 | `4` |
| 7 | Menu2 | int | 固定 | 菜单位置Y,通常填5 | `5` |
| 8 | Menu3 | int | 固定 | 菜单位置Z,通常填6 | `6` |
| 9 | Display | int | 0/1 | 是否显示 | `0`=隐藏, `1`=显示 |

**?? 重要**: 前5个字段必须与服务器完全一致!

---

## 四、实战案例对照表

### 案例1: 魔法箭 (ID 0) - 最简单的单体魔法

#### 服务器配置
```properties
magic = 0   魔法箭  1  0  0  8  1  1  1 8 0  0 0 0  0 0 0  18  1  1  2
```

#### 客户端配置
```properties
magic = 0  魔法箭  8  18  1  4 5 6  1
```

#### 配置分析
| 字段 | 值 | 说明 |
|------|-----|------|
| Type | 1 | 单点伤害,只打一个目标 |
| ManaCost | 8 | 最低MP消耗,初级魔法 |
| range2/3 | 1/1 | 虽填1但Type=1只打单体 |
| **effect4** | **1** | **低伤值**: 随机到时打1点 |
| **effect5** | **8** | **中伤值**: 随机到时打8点 |
| **effect6** | **0** | **高伤值**: 随机到时打0点(异常!) |
| effect7-9 | 0/0/0 | 无额外伤害,不随熟练度提升 |
| effect10-12 | 0/0/0 | 无特殊效果 |
| ReqInt | 18 | 18智力即可学 |
| Attr | 2 | 魔法属性(蓝色能量) |

**? 伤害随机性**: 每次施法随机打1点或8点或0点,**有33%概率打0伤**!

---

### 案例2: 火球术 (ID 20) - 典型的范围魔法

#### 服务器配置
```properties
magic = 20  火球术  3  0  0  27  2  2  2 6 2  2 6 2  0 0 0  26  1  1  3
```

#### 客户端配置
```properties
magic = 20  火球术  27  26  1  4 5 6  1
```

#### 配置分析
| 字段 | 值 | 说明 |
|------|-----|------|
| Type | 3 | 范围爆炸,一次性AOE |
| ManaCost | 27 | 消耗27MP |
| range2/3 | 2/2 | 5×5格范围 (2×2+1=5) |
| **effect4** | **2** | **低伤值**: 随机到时打2点 |
| **effect5** | **6** | **中伤值**: 随机到时打6点 |
| **effect6** | **2** | **高伤值**: 随机到时打2点(错误配置!) |
| **effect7** | **2** | 低伤额外+2 (熟练度100%时=4点) |
| **effect8** | **6** | 中伤额外+6 (熟练度100%时=12点) |
| **effect9** | **2** | 高伤额外+2 (熟练度100%时=4点) |
| effect10-12 | 0/0/0 | 无特殊效果 |
| ReqInt | 26 | 26智力 |
| Attr | 3 | 火属性(红色火焰) |

**? 伤害随机性**: 
- 熟练度0%: 随机打2点或6点或2点(无暴击)
- 熟练度100%: 随机打4点或12点或4点
- **配置问题**: effect6应该>effect5,建议改为20

---

### 案例3: 毒云 (ID 46) - 持续毒伤

#### 服务器配置
```properties
magic = 46  毒云  14  0  30  48  1  1  0 15 0  0 0 0  10 2 1  49  1  1  1
```

#### 客户端配置
```properties
magic = 46  毒云  48  49  1  4 5 6  1
```

#### 配置分析
| 字段 | 值 | 说明 |
|------|-----|------|
| Type | **14** | 毒云,持续毒伤范围 |
| Last | **30** | 持续30秒 |
| ManaCost | 48 | 消耗48MP |
| range2/3 | 1/1 | 3×3格范围 |
| effect4-6 | 0/15/0 | 每次15点毒伤 |
| effect7-9 | 0/0/0 | 无额外伤害 |
| effect10 | **10** | 持续10次伤害 |
| effect11 | **2** | 每2秒伤害一次 |
| effect12 | **1** | 毒云相关参数 |
| ReqInt | 49 | 49智力 |
| Attr | 1 | 毒属性(绿色毒雾) |

**? 特点**: Type=14专用于毒云,effect10=次数,effect11=频率

---

### 案例4: 流星攻击 (ID 81) - 多次伤害型

#### 服务器配置
```properties
magic = 81  流星攻击  21  0  0  120  2  2  6 8 12  7 12 18  0 0 0  169  1  1  3
```

#### 客户端配置
```properties
magic = 81  流星攻击  140  169  1  4 5 6  1
```

#### 配置分析
| 字段 | 值 | 说明 |
|------|-----|------|
| Type | **21** | 流星群攻,多次范围伤害 |
| ManaCost | 120 | 消耗120MP |
| range2/3 | 2/2 | 5×5格范围 |
| effect4-6 | 6/8/12 | 基础伤害6-12点 |
| effect7-9 | 7/12/18 | 熟练度100%额外+7-18伤害 |
| effect10-12 | 0/0/0 | 无特殊效果 |
| ReqInt | 169 | 169智力 |
| Attr | 3 | 火属性 |

**? 特点**: Type=21会多次判定,每次打不同目标

---

### 案例5: 暴雪 (ID 91) - 持续伤害型

#### 服务器配置
```properties
magic = 91  暴雪  27  0  0  170  3  3  6 5 21  7 8 20  20 0 0  200  100  1  4
```

#### 客户端配置
```properties
magic = 91  暴雪  170  195  100  4 5 6  1
```

#### 配置分析
| 字段 | 值 | 说明 |
|------|-----|------|
| Type | **27** | **持续多段伤害** (最强AOE类型) |
| ManaCost | 170 | 消耗170MP,高级魔法 |
| range2/3 | 3/3 | 7×7格超大范围 |
| **effect4** | **6** | **低伤值**: 随机到时打6点 |
| **effect5** | **5** | **中伤值**: 随机到时打5点 |
| **effect6** | **21** | **高伤值**: 随机到时打21点(暴击!) |
| **effect7** | **7** | 低伤额外+7 (熟练度100%时=13点) |
| **effect8** | **8** | 中伤额外+8 (熟练度100%时=13点) |
| **effect9** | **20** | 高伤额外+20 (熟练度100%时=41点暴击!) |
| effect10 | **20** | **禁锢20秒** (重要!) |
| effect11-12 | 0/0 | 未使用 |
| ReqInt | 200 | 200智力,高要求 |
| Cost | **100** | 学习费用100金币 |
| Attr | 4 | 冰属性(蓝白冰晶) |

**? 伤害随机性**: 
- 熟练度0%: 随机打6点或5点或21点(暴击3.5倍!)
- 熟练度100%: 随机打13点或13点或41点(超暴击!)
- **多段伤害**: Type=27会持续判定多次,每次都随机
- **禁锢效果**: effect10=20,被打中禁锢20秒

---

### 案例6: 寒箭埋骨 (ID 97) - 终极冰系多波伤害

#### 服务器配置
```properties
magic = 97  寒箭埋骨  34  0  0  200  3  3  8 7 28  9 10 26  20 3 4  180  -1  1  4
```

#### 客户端配置
```properties
magic = 97  寒箭埋骨  200  180  -1  4 5 6  1
```

#### 配置分析
| 字段 | 值 | 说明 |
|------|-----|------|
| Type | **34** | **终极冰系魔法** - 多波次范围伤害,第一波必中 |
| ManaCost | 200 | 消耗200MP |
| range2/3 | 3/3 | 7×7格超大范围 |
| **effect4** | **8** | **低伤值**: 随机到时打8点 |
| **effect5** | **7** | **中伤值**: 随机到时打7点 |
| **effect6** | **28** | **高伤值**: 随机到时打28点(超暴击!) |
| **effect7** | **9** | 低伤额外+9 (熟练度100%时=17点) |
| **effect8** | **10** | 中伤额外+10 (熟练度100%时=17点) |
| **effect9** | **26** | 高伤额外+26 (熟练度100%时=54点超暴击!) |
| **effect10** | **20** | **冰冻20秒** (重要!) |
| **effect11** | **3** | **每波命中3次** |
| **effect12** | **4** | **总共4波伤害** |
| ReqInt | 180 | 180智力 |
| Cost | **-1** | 不可学习(租用魔法) |
| Attr | **4** | **冰属性** (蓝白冰晶) |

#### 🎯 寒箭埋骨的特殊机制

**多波次伤害计算:**

| 波次 | 命中次数 | 魔抗检查 | 实际效果 |
|------|---------|----------|----------|
| 第1波 | 3次 | **不检查** | 必中3次 |
| 第2波 | 3次 | 检查 | 0~3次(看魔抗) |
| 第3波 | 3次 | 检查 | 0~3次(看魔抗) |
| 第4波 | 3次 | 检查 | 0~3次(看魔抗) |

**对单个目标的伤害:**
- **最小伤害**: 3次 (后续波全被抵抗的情况)
- **最大伤害**: 12次 (4波 × 3次/波 = 12次)
- **冰冻效果**: 第一波第一次命中时施加冰冻,持续20秒

#### 🔄 与暴雪(91)的关键差异

| 对比项 | 暴雪(91) | 寒箭埋骨(97) | 优势 |
|--------|---------|-------------|------|
| Type | 27(路径型) | **34(波次型)** | 🎯 寒箭埋骨伤害更稳定 |
| 第一波 | 检查魔抗 | **不检查魔抗** | 🎯 寒箭埋骨第一波必中 |
| 伤害次数 | 距离相关 | **固定4波×3次** | 🎯 寒箭埋骨可配置 |
| 冰冻 | 20秒 | 20秒 | 平手 |
| 伤害值 | 6-21 (+7-20) | 8-28 (+9-26) | 🎯 寒箭埋骨更高 |
| 学习方式 | 可学习(100金) | 租用魔法 | 不同 |

**🎯 设计思路**: 
- 使用新的Type=34实现多波次伤害
- 第一波必中保证基础伤害
- 后续波次检查魔抗,体现魔抗价值
- 可通过effect11/12配置调整伤害波数和次数

---

## 五、实战配置总结表

### 魔法类型选择指南

| 需求 | 推荐Type | 范围建议 | 伤害配置 | 典型案例 |
|------|---------|---------|---------|---------|
| 单体快速输出 | 1 | 0/0 | 高伤,无额外 | 魔法箭(0) |
| 范围爆炸AOE | 3 | 1-2 | 中伤+额外 | 火球术(20) |
| 路径持续伤害 | 27 | 2-3 | 中高伤+effect10冰冻 | 暴雪(91) |
| 多波次AOE | 34 | 2-3 | 中高伤+波次配置 | 寒箭埋骨(97) |
| 屏幕范围AOE | 35 | 大范围 | 多波伤害,只对NPC | 冰封领域(98) |
| 多次打击AOE | 21 | 2-3 | 中伤+额外 | 流星攻击(81) |
| 毒伤DOT | 14 | 1-2 | 低伤+高频 | 毒云(46) |

### 配置模板速查

#### 模板1: 单体高伤魔法
```properties
# 服务器
magic = [ID]  [名称]  1  0  0  [MP]  0  0  [min] [avg] [max]  [+min] [+avg] [+max]  0 0 0  [智力]  1  1  [属性]

# 客户端
magic = [ID]  [名称]  [MP]  [智力]  1  4 5 6  1
```

#### 模板2: 中范围AOE
```properties
# 服务器
magic = [ID]  [名称]  3  0  0  [MP]  2  2  [min] [avg] [max]  [+min] [+avg] [+max]  0 0 0  [智力]  1  1  [属性]

# 客户端
magic = [ID]  [名称]  [MP]  [智力]  1  4 5 6  1
```

#### 模板3: 路径持续伤害 (类似暴雪)
```properties
# 服务器
magic = [ID]  [名称]  27  0  0  [MP]  3  3  [min] [avg] [max]  [+min] [+avg] [+max]  [冰冻秒] 0 0  [智力]  1  1  4

# 客户端
magic = [ID]  [名称]  [MP]  [智力]  1  4 5 6  1
```

#### 模板4: 多波次AOE (类似寒箭埋骨)
```properties
# 服务器 - Type 34
# effect10=冰冻秒数, effect11=每波命中次数, effect12=总波数
magic = [ID]  [名称]  34  0  0  [MP]  3  3  [min] [avg] [max]  [+min] [+avg] [+max]  [冰冻秒] [每波次数] [总波数]  [智力]  1  1  4

# 客户端
magic = [ID]  [名称]  [MP]  [智力]  1  4 5 6  1
```

---

## 六、常见问题解答

### Q1: 为什么我的魔法没有动画?
**A**: 客户端动画效果ID = 魔法ID + 100。比如魔法ID=97,需要在客户端代码中添加case 197的动画处理。如果没有客户端代码支持,建议使用0-96中已有动画的ID。

### Q2: Type 21和Type 27有什么区别?
**A**: 
- **Type 21**: 多次独立AOE判定,每次可以打到不同目标(流星雨效果)
- **Type 27**: 持续范围伤害,在固定区域持续造成伤害(暴雪效果)

### Q3: 如何让魔法带控制效果?
**A**: 使用Type=27 + effect10设置禁锢秒数。例如暴雪的effect10=20表示禁锢20秒。如果设为0则无禁锢。

### Q4: 为什么我修改了配置文件没生效?
**A**: 
1. **服务器**需要重启才能加载新的Magic.cfg
2. **客户端**需要重启才能加载新的MAGICCFG.txt
3. 确认两个文件的ID、名称、MP、智力、费用完全一致
4. 检查配置文件格式,字段用**空格**分隔(不是Tab)

### Q5: 如何添加新魔法的图标?
**A**: 
1. 准备30×30像素PNG图标(透明背景)
2. 使用Pak编辑器打开`New Client\SPRITES\gldhall.pak`
3. 找到sprite_0000(魔法图标图集)
4. 定位到Brush #[魔法ID]位置
5. 粘贴图标并保存

### Q6: 如何克隆现有魔法?
**A**: 
1. 从Magic.cfg复制你想克隆的魔法配置
2. 修改第1个字段(ID)为新ID
3. 修改第2个字段(名称)为新名称
4. 调整伤害、MP、智力等参数
5. 在MAGICCFG.txt中添加对应的客户端配置
6. 如果使用0-96的ID,自动继承原ID的图标和动画

### Q7: effect10/11/12有什么用?
**A**: 
**完全取决于魔法的 Type 类型!** 详见上方"effect10/11/12 特殊参数详解"章节。

**快速参考**:
- **Type 14 (毒云/火墙)**: 三个参数定义动态对象(类型/形状/范围)
- **Type 23/27 (冰系/暴雪)**: effect10=禁锢秒数, effect11/12=0
- **Type 30 (地震)**: effect10=破甲值, effect11/12=0
- **Type 36 (群体魔法)**: effect12=目标魔法ID, effect10/11=0
- **其他 Type**: 全部填 0

### Q8: 如何设计平衡的伤害?
**A**: 参考同等级魔法的伤害范围:
- **初级(1-20级)**: 基础2-10, 额外1-5
- **中级(20-50级)**: 基础5-20, 额外3-10
- **高级(50-80级)**: 基础10-40, 额外5-20
- **终极(80+级)**: 基础20-80, 额外10-40

### Q9: 范围太大会不会不平衡?
**A**: 可以通过以下方式平衡:
- 提高MP消耗 (range3→MP 150+)
- 降低伤害 (大范围→低伤害)
- 提高智力需求 (range3→ReqInt 150+)
- 增加学习费用 (range3→Cost 50+)

### Q10: 可以创建ID 100以上的魔法吗?
**A**: 
- **服务器**: 理论上可以,但未经过充分测试
- **客户端**: 需要大量代码修改,不推荐
- **建议**: 使用0-96中不常用的ID,或者覆盖现有魔法

---

## 七、完整实战案例: 混沌圣火 (ID 97)

### 设计目标
克隆暴雪(ID 91)创建火系持续伤害魔法,具备以下特点:
- ? 使用Type=27的持续多段伤害
- ? 改为火属性(Attr=3)
- ? 去掉禁锢效果(effect10=0)
- ? 提高伤害补偿(8-28比暴雪6-21高)
- ? 降低学习门槛(智力180, 费用1金)

### 步骤1: 服务器配置

编辑 `Server\WorldServer\Magic.cfg`,添加:
```properties
magic = 97  混沌圣火  27  0  0  200  3  3  8 7 28  9 10 26  0 0 0  180  1  1  3
```

### 步骤2: 客户端配置

编辑 `New Client\CONTENTS\MAGICCFG.txt`,添加:
```properties
magic = 97  混沌圣火  200  180  1  4 5 6  1
```

### 步骤3: 添加图标

使用Pak编辑器打开 `gldhall.pak`,在Brush #97位置添加30×30火焰图标。

### 步骤4: 添加动画 (可选)

如果需要自定义动画,参考原文档"混沌圣火"部分的5处客户端代码修改。如果使用0-96的ID,可以跳过此步骤。

### 步骤5: 测试验证

1. 重启服务器
2. 重启客户端
3. 进游戏测试:
   - ? 图标显示正确
   - ? MP消耗200
   - ? 7×7格超大范围
   - ? 持续多段伤害
   - ? 火焰视觉效果
   - ? 无禁锢效果

---

## 附录A: 动画位置对齐规律 (重要!)

### ? 核心发现: 坐标系统决定是否需要手动偏移

游戏中有**两种坐标系统**,选择不同的坐标系统,图片对齐方式完全不同!

#### 方法1: 格子坐标 (推荐?????)

**初始化时使用 `sX, sY`**:
```cpp
case 75: // 混沌圣火子效果
    m_pEffectList[i]->m_mX = sX;  // 格子坐标(32的倍数)
    m_pEffectList[i]->m_mY = sY;
    break;
```

**绘制时**:
```cpp
case 75: // 混沌圣火绘制
    dX = (m_pEffectList[i]->m_mX) - m_sViewPointX; 
    dY = (m_pEffectList[i]->m_mY) - m_sViewPointY; 
    m_pEffectSpr[122]->PutTransSprite_NoColorKey(dX, dY, cTempFrame, dwTime);
    // 无需手动偏移!图片会自动居中对齐到格子!
    break;
```

**优点**:
- ? **图片自动居中对齐**,无需计算偏移量
- ? 对齐到格子边界,视觉效果更整齐
- ? 与暴雪(case 72)等原版魔法一致
- ? 适用于任意尺寸的图片

**典型案例**: 暴雪(case 72), 所有原版魔法

---

#### 方法2: 像素坐标 (需要手动偏移)

**初始化时使用 `dX, dY`**:
```cpp
case 75: // 混沌圣火子效果
    m_pEffectList[i]->m_mX = dX;  // 像素坐标(精确位置)
    m_pEffectList[i]->m_mY = dY;
    break;
```

**绘制时需要手动偏移**:
```cpp
case 75: // 混沌圣火绘制
    dX = (m_pEffectList[i]->m_mX) - m_sViewPointX; 
    dY = (m_pEffectList[i]->m_mY) - m_sViewPointY; 
    dX -= 282;  // 图片宽度565 / 2 = 282
    dY -= 190;  // 图片高度381 / 2 = 190
    m_pEffectSpr[122]->PutTransSprite_NoColorKey(dX, dY, cTempFrame, dwTime);
    break;
```

**缺点**:
- ? 需要知道图片的**实际尺寸**
- ? 每个魔法都要单独计算偏移
- ? 图片尺寸改变需要重新调整
- ? 容易出现对齐偏差

**何时使用**: 需要精确控制像素级位置时(极少数情况)

---

### ? 实际案例对比

| 魔法 | case | 初始化坐标 | 绘制偏移 | 说明 |
|------|------|----------|---------|------|
| 暴雪 | 72 | `sX, sY` | 无 | 标准做法,自动居中 |
| 混沌圣火(旧) | 75 | `dX, dY` | `-282, -190` | 需要手动计算 |
| 混沌圣火(新) | 75 | `sX, sY` | 无 | 改为自动居中 |
| StormBlade | 81 | 未知 | `+70, +70` | 手动微调 |

---

### ? 开发建议

1. **新魔法一律用格子坐标** (`sX, sY`)
2. **绘制时不要添加任何偏移**,让图片自动居中
3. 如果位置还有问题,检查:
   - bAddNewEffect调用时的参数顺序
   - 是否误用了像素坐标`dX, dY`
   - Pak文件中图片的锚点位置

4. **避免逐个调整偏移**,这是效率最低的方法!

---

## 附录B: 代码位置速查

| 功能 | 文件 | 行号 | 说明 |
|------|------|------|------|
| 服务器发送效果 | NewPartySystem.cpp | 25329 | 发送(魔法ID+100) |
| 客户端接收效果 | Game.cpp | 6973 | 调用bAddNewEffect |
| 效果初始化 | NotifyMsgHandler.cpp | 41302+ | bAddNewEffect函数 |
| 效果循环 | Game.cpp | 18000+ | 主循环处理 |
| 效果绘制 | NotifyMsgHandler.cpp | 42363+ | DrawEffects函数 |
| 资源加载 | Game.cpp | 5477-5510 | MakeEffectSpr调用 |

## 附录C: 推荐开发工具

- **Pak编辑器**: HB Pak Editor
- **图像编辑**: Photoshop / GIMP (30×30图标制作)
- **十六进制编辑**: HxD (修复Pak文件头)
- **代码编辑**: Visual Studio 6.0 / VS Code
- **版本控制**: Git

---

**文档版本**: v1.1  
**更新日期**: 2025-12-25  
**基于**: 实际Magic.cfg (92条魔法) + MAGICCFG.txt (100条配置)  
**验证**: 所有案例均来自实际运行的游戏配置

### 更新日志
- **v1.1 (2025-12-25)**: 
  - 更新寒箭埋骨(ID 97)为Type 34(终极冰系魔法)
  - 新增Type 34/35的详细说明和配置指南
  - 更新effect10/11/12参数表,增加多波次伤害参数说明
  - 修正魔法类型选择指南
- **v1.0 (2025-11-19)**: 初始版本
