# 必杀技(SuperAttack)属性详解

## 一、概述

必杀技在代码中称为 **SuperAttack**，是玩家按住 **Alt键** 点击目标时发动的特殊攻击。发动时会消耗必杀技次数（客户端显示为绿色条），并发出特殊光效。

**关键代码位置：**
- 服务端攻击处理：`HGServer/Game.cpp` → `iClientMotion_Attack_Handler()` 函数
- 服务端伤害计算：`HGServer/Game.cpp` → `iCalculateAttackEffect()` 函数（约14320行开始）
- 客户端必杀模式：`HGClient/NotifyMsgHandler.cpp`（约20260行）

**相关变量：**
| 变量名 | 位置 | 说明 |
|:-------|:-----|:-----|
| `m_iSuperAttackLeft` | 服务端/客户端 | 剩余必杀技次数 |
| `m_bSuperAttackMode` | 客户端 | 是否处于必杀模式（按住Alt时为TRUE） |
| `iAttackMode` | 服务端 | 攻击模式，≥20表示必杀攻击 |

---

## 二、为什么会"空砍"？

### 2.1 空砍的本质

空砍 = **攻击命中判定失败（MISS）**

即使是必杀技，也需要通过命中率判定。判定代码位于 [Game.cpp#L15330](HGServer/Game.cpp#L15330)：

```cpp
iResult = iDice(1, 100);      // 随机1-100
if(iResult <= iDestHitRatio)  // 如果随机值 ≤ 命中率
{
    // 命中！造成伤害
}
else
{
    // MISS！空砍，无伤害
}
```

### 2.2 命中率计算公式

**最终命中率公式** ([Game.cpp#L15280-L15284](HGServer/Game.cpp#L15280-L15284))：

```
最终命中率 = (攻击者命中 / 目标防御) × 50

限制范围：10% ≤ 最终命中率 ≤ 95%
```

**代码实现：**
```cpp
dTmp1 = (double)(iAttackerHitRatio);    // 攻击者命中
dTmp2 = (double)(iTargetDefenseRatio);  // 目标防御
dTmp3 = (dTmp1 / dTmp2) * 50.0f;
iDestHitRatio = (int)(dTmp3);

// 命中率上下限
if(iDestHitRatio < DEF_MINIMUMHITRATIO) iDestHitRatio = DEF_MINIMUMHITRATIO;  // 最低10%
if(iDestHitRatio > DEF_MAXIMUMHITRATIO) iDestHitRatio = DEF_MAXIMUMHITRATIO;  // 最高95%
```

**常量定义** ([Game.h#L214-L218](HGServer/Game.h#L214-L218))：
```cpp
#define DEF_MINIMUMHITRATIO 10   // 最低命中率 10%
#define DEF_MAXIMUMHITRATIO 95   // 最高命中率 95%
```

---

## 三、影响命中率的属性

### 3.1 攻击者命中 (iAttackerHitRatio)

**组成部分：**

| 来源 | 计算方式 | 代码位置 |
|:-----|:---------|:---------|
| 武器技能熟练度 | `m_cSkillMastery[武器技能]` | Game.cpp#L42982 |
| 武器升级等级 | `升级等级 × m_upgradeAttRatioFactor` | Game.cpp#L42986 |
| 武器自带命中 | `m_sItemEffectValue2` | Game.cpp#L42986 |
| 敏捷加成 | `DEX > 50 时，+(DEX - 50)` | Game.cpp#L15175 |
| 必杀技加成 | `+100`（基础） | Game.cpp#L14690 |
| 武器类型加成 | 见下表 | Game.cpp#L14680-L14688 |
| 装备额外命中 | `m_iAddAR` | Game.cpp#L14693 |

**必杀技武器类型加成：**

| 武器技能 | 技能ID | 命中加成 |
|:---------|:------:|:--------:|
| 弓箭 | 6 | +30 |
| 短剑 | 7 | +0 |
| 剑 | 8 | +30 |
| 斧头 | 10 | +0 |
| 长杖 | 14 | +20 |
| 特殊 | 21 | +50 |

### 3.2 目标防御 (iTargetDefenseRatio)

**组成部分：**

| 来源 | 计算方式 | 说明 |
|:-----|:---------|:-----|
| 敏捷(DEX) | `DEX × 2` | 基础防御 |
| 保护魔法 | +40 或 +100 | 取决于魔法等级 |
| 装备加成 | `m_iAddDR` | 来自装备属性 |
| 背对减免 | 防御 ÷ 2 | 背对攻击者时防御减半 |

**保护魔法效果** ([Game.cpp#L15260-L15268](HGServer/Game.cpp#L15260-L15268))：
```cpp
switch(cProtect) {
    case 3: iTargetDefenseRatio += 40;  break;  // Magic Shield
    case 4: iTargetDefenseRatio += 100; break;  // Great Magic Shield
}
```

---

## 四、空砍示例计算

### 示例1：正常情况
```
攻击者：
- 武器技能熟练度：100
- 武器升级命中：+20
- DEX：60 → 额外命中 +10
- 必杀技加成：+100
- 武器类型（剑）：+30
总命中 = 100 + 20 + 10 + 100 + 30 = 260

目标：
- DEX：80 → 基础防御 = 160
- 保护魔法：无
总防御 = 160

最终命中率 = (260 / 160) × 50 = 81.25%
```
**结果：约19%概率空砍**

### 示例2：目标有保护魔法
```
攻击者总命中 = 260（同上）

目标：
- 基础防御：160
- Great Magic Shield：+100
总防御 = 260

最终命中率 = (260 / 260) × 50 = 50%
```
**结果：约50%概率空砍！**

---

## 五、如何修改以减少空砍

### 方案A：提高必杀技命中加成

**修改位置：** [Game.cpp#L14690](HGServer/Game.cpp#L14690)

```cpp
// 原代码
iAttackerHitRatio += 100;

// 修改为（例如+300）
iAttackerHitRatio += 300;
```

**效果：** 必杀技命中率大幅提升，但仍受95%上限限制

---

### 方案B：必杀技命中率固定为最大值（推荐）

**修改位置：** [Game.cpp#L15287](HGServer/Game.cpp#L15287)

```cpp
// 原代码
if(iDestHitRatio > DEF_MAXIMUMHITRATIO) iDestHitRatio = DEF_MAXIMUMHITRATIO;

// 在这行后面添加
if(iAttackMode >= 20) iDestHitRatio = DEF_MAXIMUMHITRATIO;  // 必杀技95%命中
```

**效果：** 必杀技固定95%命中率，只有5%概率空砍

---

### 方案C：必杀技100%必中

**修改位置：** [Game.cpp#L15287](HGServer/Game.cpp#L15287)

```cpp
// 原代码
if(iDestHitRatio > DEF_MAXIMUMHITRATIO) iDestHitRatio = DEF_MAXIMUMHITRATIO;

// 在这行后面添加
if(iAttackMode >= 20) iDestHitRatio = 100;  // 必杀技100%必中
```

**效果：** 必杀技永不空砍

---

### 方案D：提高命中率上限

**修改位置：** [Game.h#L218](HGServer/Game.h#L218)

```cpp
// 原代码
#define DEF_MAXIMUMHITRATIO 95

// 修改为
#define DEF_MAXIMUMHITRATIO 100
```

**效果：** 所有攻击的命中上限提高到100%（影响范围大，需谨慎）

---

## 六、推荐方案

**推荐使用方案B或方案C**，理由：
1. 只影响必杀技，不影响普通攻击的游戏平衡
2. 修改简单，只需添加一行代码
3. 玩家消耗了必杀技次数，理应获得更高的命中保障

---

## 七、相关数值汇总

| 参数 | 数值 | 定义位置 |
|:-----|:-----|:---------|
| 最低命中率 | 10% | Game.h#L214 |
| 最高命中率 | 95% | Game.h#L218 |
| 必杀技命中加成 | +100 | Game.cpp#L14690 |
| 必杀技上限 | 18 | Client.cpp#L315 |
| 攻击模式阈值 | ≥20 | 多处 |

---

*文档生成时间：2026年1月12日*
*代码版本：基于当前工作区代码分析*
