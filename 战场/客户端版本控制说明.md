# 客户端版本控制说明

## 配置文件位置

| 端 | 文件路径 | 说明 |
|:--:|:--------|:-----|
| 服务端 | `Server\HMLServer.cfg` | 第13行 `Version` 字段 |
| 客户端 | `New Client\ver` | 整个文件只有版本号 |

---

## 当前版本

- 服务端：`CYZC2.23`
- 客户端：`CYZC2.23`

---

## 代码验证（已确认）

### 服务端流程

1. **配置读取**：`MainServer\MainLog.cpp` 第2537行
   ```cpp
   if (memcmp(token, "Version", 7) == 0) cReadMode = 8;
   ```

2. **存储到变量**：第2505-2507行
   ```cpp
   ZeroMemory(m_cCurrentVersion, sizeof(m_cCurrentVersion));
   strcpy(m_cCurrentVersion, token);
   wsprintf(G_cTxt, "(*)Version: %s", m_cCurrentVersion);
   ```

3. **登录时检查**：第833-838行
   ```cpp
   memcpy(cCheckVersion, cp, 20);  // 从客户端接收的版本号
   if(strcmp(cCheckVersion, m_cCurrentVersion) != 0)
   {
       SendEventToWLS(DEF_LOGRESMSGTYPE_WRONGVERSION, ...);
       return;  // 版本不匹配，拒绝登录
   }
   ```

**结论：服务端确实从 `HMLServer.cfg` 的 `Version` 字段读取版本号，并与客户端发送的版本进行字符串比较。**

---

## 强制玩家更新客户端

### 步骤1：修改服务端版本号

编辑 `Server\HMLServer.cfg`，找到第13行：
```
Version   =  CYZC2.23
```
改为新版本号，例如：
```
Version   =  CYZC2.24
```

### 步骤2：重启 MainServer（HMLServer）

重启主登录服务器，让新版本号生效。启动时会显示日志：
```
(*)Version: CYZC2.24
```

### 步骤3：此时旧客户端无法登录

玩家使用旧客户端（版本 `CYZC2.23`）登录时会被拒绝，返回版本错误。

### 步骤4：发布新客户端

修改 `New Client\ver` 文件内容为：
```
CYZC2.24
```
然后打包发布给玩家。

---

## 注意事项

1. **版本号必须完全一致**，服务端和客户端的版本字符串要完全匹配（区分大小写）
2. **无需重新编译**，只需修改配置文件
3. **只需重启 MainServer（HMLServer）**，GameServer 不需要重启
4. 版本号最大长度 **20个字符**
5. 建议版本号格式：`CYZC主版本.次版本`，例如 `CYZC2.24`
