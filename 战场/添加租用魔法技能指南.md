# 添加租用魔法技能指南

本文档说明如何在游戏中添加一个新的租用魔法技能。

## 概述

租用魔法系统允许玩家使用黑色点数或魔法珍珠租用特定魔法技能，租用后会在指定时间内拥有该魔法的使用权限。

## 涉及的文件

1. **配置文件**：
   - `Server/GameServer/BorrowItem.cfg` - 租用物品配置

2. **服务器源码**：
   - `HGServer/Client.h` - 客户端数据结构
   - `HGServer/Client.cpp` - 客户端初始化
   - `HGServer/NewPartySystem.cpp` - 租用逻辑、保存、加载
   - `HGServer/Game.cpp` - 登录提示、过期检查

## 添加步骤

### 第 1 步：配置租用项目（BorrowItem.cfg）

在 `Server/GameServer/BorrowItem.cfg` 中添加新的租用配置：

```ini
[MITEM8]
name = 寒剑埋骨
nPricePerMonth = 200000
costType = 2
```

**配置说明**：
- `[MITEMx]`：租用项目编号，**必须连续**（从 MITEM1 开始，不能跳号）
- `name`：租用的魔法名称（必须与后续代码中使用的名称完全一致）
- `nPricePerMonth`：每月租用价格
- `costType`：支付类型
  - `1` = 魔法珍珠
  - `2` = 黑色点数

**?? 重要**：MItem 编号必须连续，否则会导致索引错位！

### 第 2 步：添加租用时间变量（Client.h）

在 `HGServer/Client.h` 的 CClient 类中添加租用时间变量：

```cpp
class CClient
{
public:
    // ... 其他成员变量 ...
    
    int m_timeRemoveEQ;         // 移除地震魔法的年月日
    int m_timeRemoveJieChu;     // 移除解除魔法的年月日
    int m_timeRemoveFengMo;     // 移除封魔魔法的年月日
    int m_timeRemoveHunLuan;    // 移除混乱魔法的年月日
    int m_timeRemoveHanJian;    // 移除寒剑埋骨魔法的年月日  ← 新增
};
```

**位置**：大约在 line 241-245 附近，和其他租用时间变量放在一起。

### 第 3 步：初始化变量（Client.cpp）

在 `HGServer/Client.cpp` 的 CClient 构造函数中初始化：

```cpp
CClient::CClient(HWND hWnd, WORD wID, char * pAddress)
{
    // ... 其他初始化 ...
    
    m_timeRemoveEQ = 0;
    m_timeRemoveJieChu = 0;
    m_timeRemoveFengMo = 0;
    m_timeRemoveHunLuan = 0;
    m_timeRemoveHanJian = 0;    // ← 新增
}
```

**位置**：大约在 line 94 附近。

### 第 4 步：添加租用逻辑（NewPartySystem.cpp）

在 `HGServer/NewPartySystem.cpp` 的租用处理函数中添加新魔法的租用逻辑：

```cpp
// 大约在 line 18970 附近
else if(strcmp(m_pItemBorrowConfigList[iBorrowItemIndex]->cGotItemName, "寒剑埋骨") == 0)
{
    // 1. 检查是否已经学会
    if(m_pClientList[iClientH]->m_cMagicMastery[97] != 0)
    {
        ShowClientMsg(iClientH, "你原本就已经学会了寒剑埋骨魔法.");
        return;
    }
    
    // 2. 扣除费用
    if(m_pItemBorrowConfigList[iBorrowItemIndex]->costType == 1)
    {
        // 魔法珍珠支付
        SetItemCount(iClientH, iMagicPearlIndex, 
            m_pClientList[iClientH]->m_pItemList[iMagicPearlIndex]->m_dwCount - nMonths * m_pItemBorrowConfigList[iBorrowItemIndex]->nPricePerMonth,
            TRUE, FALSE, nMonths * m_pItemBorrowConfigList[iBorrowItemIndex]->nPricePerMonth);
    }
    else if(m_pItemBorrowConfigList[iBorrowItemIndex]->costType == 2)
    {
        // 黑色点数支付
        ModifyPlayerBlackPoint(iClientH, -nMonths * m_pItemBorrowConfigList[iBorrowItemIndex]->nPricePerMonth);
    }
    
    // 3. 设置魔法掌握度（索引 97 对应寒剑埋骨）
    m_pClientList[iClientH]->m_cMagicMastery[97] = 1;

    // 4. 计算到期时间
    SYSTEMTIME SysTime;			
    GetLocalTime(&SysTime);
    SysTime.wMonth += nMonths;
    while(SysTime.wMonth > 12)
    {
        SysTime.wMonth -= 12;
        SysTime.wYear++;
    }
    SysTime.wYear -= 2000;		
    m_pClientList[iClientH]->m_timeRemoveHanJian = SysTime.wYear*10000+(short)SysTime.wMonth*100 + (short)SysTime.wDay;

    // 5. 显示租用成功提示
    sprintf(G_cTxt, "租用寒剑埋骨魔法成功！到期时间：20%d年%d月%d日",
        (int)(m_pClientList[iClientH]->m_timeRemoveHanJian / 10000),
        (int)((m_pClientList[iClientH]->m_timeRemoveHanJian % 10000) / 100),
        m_pClientList[iClientH]->m_timeRemoveHanJian % 100);
    ShowClientMsg(iClientH, G_cTxt);

    // 6. 发送学习成功通知（客户端动画）
    char cData[512];
    DWORD *dwp;
    WORD *wp;
    char *cp;
    dwp  = (DWORD *)(cData + DEF_INDEX4_MSGID);
    *dwp = MSGID_NOTIFY;
    wp   = (WORD *)(cData + DEF_INDEX2_MSGTYPE);
    *wp  = DEF_NOTIFY_MAGICSTUDYSUCCESS;
    cp = (char *)(cData + DEF_INDEX2_MSGTYPE + 2);			
    *cp = 97;  // 魔法索引
    cp++;
    memcpy(cp, m_pItemBorrowConfigList[iBorrowItemIndex]->cGotItemName, 30);
    cp += 30;

    int iRet = m_pClientList[iClientH]->m_pXSock->iSendMsg(cData, 37);
    bIsSocketStocked(iRet, iClientH);
    return;
}
```

**关键参数**：
- `m_cMagicMastery[97]`：魔法掌握度数组索引
  - 地震=96, 寒剑=97, 封魔=98, 混乱=99（索引比魔法ID小1）
- `*cp = 97`：发送给客户端的魔法索引

### 第 5 步：添加保存逻辑（NewPartySystem.cpp）

在角色保存函数中添加到期时间的保存：

```cpp
// 大约在 line 22043 附近
wsprintf(cTxt, "RmvHLDate = %d", m_pClientList[iClientH]->m_timeRemoveHunLuan);
strcat(pData, cTxt);
strcat(pData, "\n");

wsprintf(cTxt, "RmvHJDate = %d", m_pClientList[iClientH]->m_timeRemoveHanJian);  // ← 新增
strcat(pData, cTxt);
strcat(pData, "\n");
```

**位置**：在其他 RmvXXDate 保存代码附近。

### 第 6 步：添加加载逻辑（NewPartySystem.cpp）

在角色加载函数中添加两个地方：

#### 6.1 添加 case 标签（大约 line 27145）

```cpp
case 119: m_timeRemoveEQ = Str2Int(token); break;
case 120: m_timeRemoveJieChu = Str2Int(token); break;
case 121: m_timeRemoveFengMo = Str2Int(token); break;
case 122: m_timeRemoveHunLuan = Str2Int(token); break;
case 123: m_timeRemoveHanJian = Str2Int(token); break;  // ← 新增
```

#### 6.2 识别标签名称（大约 line 27368）

```cpp
else if(memNcmp(token, "RmvEqDate", 9) == 0) cReadModeA = 119;
else if(memNcmp(token, "RmvJCDate", 9) == 0) cReadModeA = 120;
else if(memNcmp(token, "RmvFMDate", 9) == 0) cReadModeA = 121;
else if(memNcmp(token, "RmvHLDate", 9) == 0) cReadModeA = 122;
else if(memNcmp(token, "RmvHJDate", 9) == 0) cReadModeA = 123;  // ← 新增
```

### 第 7 步：添加登录提示（Game.cpp）

在玩家登录时显示租用到期时间：

```cpp
// 大约在 line 5289 附近
if(m_pClientList[i]->m_timeRemoveHanJian > 0)
{
    sprintf(G_cTxt, "您的寒剑埋骨使用到期时间为:20%d年%d月%d日",
        (int)(m_pClientList[i]->m_timeRemoveHanJian / 10000),
        (int)((m_pClientList[i]->m_timeRemoveHanJian % 10000) / 100),
        m_pClientList[i]->m_timeRemoveHanJian % 100);
    ShowClientMsg(i, G_cTxt);
}
```

**位置**：在其他租用魔法登录提示附近。

### 第 8 步：添加过期检查（Game.cpp）

在时间检查函数中添加过期清除逻辑：

```cpp
// 大约在 line 49745 附近
if(iDateSum > m_pClientList[iClientH]->m_timeRemoveHanJian)
{
    m_pClientList[iClientH]->m_cMagicMastery[97] = 0;
    m_pClientList[iClientH]->m_timeRemoveHanJian = 0;
}
```

**位置**：在其他租用魔法过期检查附近。

## 魔法索引对照表

| 魔法名称 | 魔法 ID | magic-mastery 索引 | 变量名 | 文件标签 |
|---------|---------|-------------------|--------|----------|
| 地震魔法 | 97 | 96 | m_timeRemoveEQ | RmvEqDate |
| 解除魔法 | 77 | 76 | m_timeRemoveJieChu | RmvJCDate |
| 封魔魔法 | 84 | 83 | m_timeRemoveFengMo | RmvFMDate |
| 混乱魔法 | 99 | 98 | m_timeRemoveHunLuan | RmvHLDate |
| 寒剑埋骨 | 98 | 97 | m_timeRemoveHanJian | RmvHJDate |

**规律**：`magic-mastery 索引 = 魔法ID - 1`

## 编译和部署

1. 编译服务器：
   ```batch
   cd d:\GitProject\cyzc_old
   .\build_server.bat
   ```

2. 编译完成后，HGserver.exe 会自动复制到 `Server/GameServer/` 目录

3. 重启服务器以应用更改

## 测试检查清单

- [ ] 租用界面能正常打开
- [ ] 显示正确的租用价格
- [ ] 扣除费用正确（黑色点数或魔法珍珠）
- [ ] 租用时立即显示到期时间提示
- [ ] 魔法掌握度正确设置为 1
- [ ] 角色文件中保存了 RmvXXDate 字段
- [ ] 退出重新登录后显示租用到期时间
- [ ] 到期后魔法自动清除

## 常见问题

### Q1：租用后魔法没有保存？
**A**：检查是否在 NewPartySystem.cpp 的保存函数中添加了 `wsprintf` 保存逻辑。

### Q2：登录时不显示到期时间？
**A**：检查 Game.cpp 中是否添加了登录提示代码，并且变量名是否正确。

### Q3：BorrowItem.cfg 修改后不生效？
**A**：确保 MItem 编号是连续的，配置文件使用 ANSI/GBK 编码，重启服务器。

### Q4：租用后崩溃？
**A**：检查 magic-mastery 索引是否正确（必须在 0-99 范围内）。

### Q5：过期后魔法没有清除？
**A**：检查 Game.cpp 中的过期检查逻辑是否添加。

## 文件修改总结

| 文件 | 修改次数 | 说明 |
|------|---------|------|
| BorrowItem.cfg | 1 | 添加配置项 |
| Client.h | 1 | 声明时间变量 |
| Client.cpp | 1 | 初始化变量 |
| NewPartySystem.cpp | 4 | 租用逻辑、保存、加载（2处） |
| Game.cpp | 2 | 登录提示、过期检查 |

**总计**：5 个文件，10 处修改

## 版本历史

- **2025-11-20**：初始版本，基于寒剑埋骨魔法租用功能实现

---

**注意**：所有中文字符串必须使用 GBK 编码，确保游戏客户端能正确显示。
