# 国战英雄排名机制

## 排名依据

国战英雄排名**仅依据 `m_iWarContribution`（战争贡献值）**进行排序。

## 排名计算规则

国战结束时，系统会进行以下排名计算：

1. **分阵营统计**：阿瑞登和艾尔维两个阵营分别统计排名
2. **排名依据**：完全按照 `m_iWarContribution`（战争贡献值）从高到低排序
3. **上榜条件**：
   - 在本方阵营中战争贡献值排名靠前
   - 管理员账号（`m_iAdminUserLevel > 0`）自动排除
4. **获得称号**：
   - **获胜方**：前7名获得"★国战英雄★"称号（实心星）
   - **战败方**：前4名获得"☆国战英雄☆"称号（空心星）
5. **攻击加成**：称号玩家会获得对应的攻击伤害加成（详见下方奖励章节）

## 战争贡献值获取途径详解

### 一、击杀敌方玩家

**计算公式**：
```
经验奖励 = (随机(1-3) × (被击杀者等级 × 3) + 被击杀者等级) ÷ 3
战争贡献值 = (经验奖励 - 经验奖励÷3) × 12
           = 经验奖励 × (2/3) × 12
           = 经验奖励 × 8
```

**实际例子**：
- 击杀120级玩家：经验奖励约120-360，战争贡献值约 **960-2880**
- 击杀150级玩家：经验奖励约150-450，战争贡献值约 **1200-3600**
- 击杀180级玩家：经验奖励约180-540，战争贡献值约 **1440-4320**

**注意**：击杀玩家是获得贡献值最快的方式之一，且每次奖励有随机波动。

### 二、建造/摧毁建筑物

#### 建造己方建筑（建造完成时获得）

| 建筑类型 | 建设点 | 战争贡献值 | 说明 |
|---------|--------|-----------|------|
| 战车 (Type 36: AGT) | 700 | **+700** | 阿瑞登城门/战车 |
| 战车 (Type 37: CGT) | 700 | **+700** | 艾尔维城门/战车 |
| 采集机 (Type 38) | 500 | **+500** | 资源采集建筑 |
| 侦测仪 (Type 39) | 500 | **+500** | 侦测建筑 |

**建造说明**：建筑建造完成时**立即获得**对应的建设点和战争贡献值。

#### 击杀敌方NPC/建筑

| 目标类型 | 建设点 | 战争贡献值 | 说明 |
|---------|-------|-----------|------|
| **主要建筑** |
| 敌方城门 AGT/CGT (Type 36/37) | 700 | **4000** | 摧毁后获得高额贡献 |
| 采集机 (Type 38) | 500 | **2000** | 摧毁敌方采集机 |
| 侦测仪 (Type 39) | 500 | **2000** | 摧毁敌方侦测仪 |
| 能源防护装置 (Type 40) | 1500 | **4000** | 重要防御建筑 |
| 魔法发动机 (Type 41) | 5000 | **10000** | 最高贡献值！核心建筑 |
| **战斗单位** |
| 轻甲虫 (Type 43) | 500 | **1000** | 敌方召唤单位 |
| 神之剑 (Type 44) | 1000 | **2000** | 强力战斗单位 |
| 神之剑骑兵 (Type 45) | 1500 | **3000** | 高级战斗单位 |
| 教坛之剑 (Type 46) | 1000 | **2000** | 特殊战斗单位 |
| 战斗泥人 (Type 47) | 1500 | **3000** | 召唤单位 |
| **普通守卫** |
| Type 1-6 守卫 | 50 | **100** | 每个城市守卫 |

**特别提示**：
- 摧毁魔法发动机（Type 41）可获得10000贡献值，是单次获得最高的来源！
- 城门（AGT/CGT）虽然难打，但给4000贡献值，性价比很高
- 击杀玩家的贡献值虽然单次少一些，但累积起来也很可观

### 三、军团长特殊加成

如果你是军团长（`m_iGuildRank <= 1`），可以获得下属成员贡献的额外加成：

**计算公式**：
```
军团长额外贡献 = 下属成员建设点数 ÷ 10
```

**说明**：
- 当军团成员交上建设点数时，军团长会获得该成员建设点数的10%作为战争贡献值
- 这是军团长独有的贡献来源，可以通过组织团队行动快速积累贡献

### 四、战败方补偿

如果你的阵营战败了：

**补偿贡献值** = 你的角色等级

**说明**：
- 这是一个安慰奖，数值很小
- 例如180级玩家战败只能获得180贡献值
- **即使有这个补偿，战败方也无法获得国战英雄称号**

## 如何高效获取战争贡献值

根据以上数据分析，以下是最有效的刷贡献值策略：

### 最高效率途径（推荐优先级）

1. **摧毁魔法发动机** (+10000) - 单次最高，但难度最大
2. **摧毁城门 AGT/CGT** (+4000) - 性价比极高，是主要目标
3. **击杀敌方玩家** (+960-4320) - 根据等级不同，可重复，适合PK高手
4. **摧毁能源防护装置** (+4000) - 重要战略目标
5. **击杀高级战斗单位** (+1000-3000) - 神之剑、战斗泥人等
6. **摧毁采集机/侦测仪** (+2000) - 性价比中等

### 实战建议

**对于个人玩家**：
- 专注击杀敌方玩家，选择与自己等级接近的目标
- 参与攻击城门等大型建筑（即使不是你单独摧毁，最后一击也能获得全部贡献）
- 避免单独行动，组队更容易击杀高价值目标

**对于军团长**：
- 除了自己获取贡献，还能从成员那里获得额外贡献
- 组织团队集体行动，攻击高价值建筑
- 分配任务让成员刷建设点，军团长可获得10%转化

**对于新手**：
- 先从击杀普通守卫（+100）开始熟悉
- 跟随大部队行动，参与攻城战
- 不要过于贪功，生存下来持续输出才能累积贡献

## 常见疑问解答



### Q2: 我打了很多建筑和怪物，为什么贡献值不高？

**A**: 不同目标给的贡献值差别巨大：
- 普通守卫只给100贡献值
- 城门能给4000贡献值
- 魔法发动机能给10000贡献值

选择攻击高价值目标才是关键！

### Q3: 上榜需要多少战争贡献值？

**A**: 这取决于你所在服务器的竞争情况。一般来说：
- 小型国战：5000-10000贡献值可能就能进前7
- 中型国战：15000-30000贡献值比较保险
- 大型国战：可能需要50000+贡献值

建议在国战过程中随时查看自己的贡献值和排名，及时调整策略。

### Q4: 战争贡献值上限是多少？

**A**: 上限是1,000,000（一百万），基本不可能达到。

### Q5: 建造建筑能立即获得贡献值吗？

**A**: 能！建造建筑**完成时立即获得**对应的建设点数和战争贡献值。

## 称号和奖励

### 国战英雄称号

国战结束时，排名靠前的玩家会获得对应称号：

**获胜方**（前7名）：

| 名次 | 头顶显示 | 上古印记奖励 |
|------|---------|-------------|
| 第1名 | ★国战英雄第一名★ | 700个 |
| 第2名 | ★国战英雄第二名★ | 600个 |
| 第3名 | ★国战英雄第三名★ | 500个 |
| 第4名 | ★国战英雄第四名★ | 400个 |
| 第5名 | ★国战英雄第五名★ | 300个 |
| 第6名 | ★国战英雄第六名★ | 200个 |
| 第7名 | ★国战英雄第七名★ | 100个 |

**战败方**（前4名）：

| 名次 | 头顶显示 | 上古印记奖励 |
|------|---------|-------------|
| 第1名 | ☆国战英雄第一名☆ | 400个 |
| 第2名 | ☆国战英雄第二名☆ | 300个 |
| 第3名 | ☆国战英雄第三名☆ | 200个 |
| 第4名 | ☆国战英雄第四名☆ | 100个 |

> **说明**：获胜方使用实心星（★），战败方使用空心星（☆）区分。上古印记奖励数量可在Settings.cfg中配置。

---

### 攻击加成效果

国战英雄称号不仅是荣誉，还会获得**永久的攻击伤害加成**，直到下次国战结束前一直有效：

**获胜方攻击加成**：

| 名次 | 加成倍数 | 效果说明 |
|------|---------|---------|
| 第1名 | **1.7倍** | 所有物理/魔法伤害×1.7（+70%伤害） |
| 第2名 | **1.5倍** | 所有物理/魔法伤害×1.5（+50%伤害） |
| 第3名 | **1.4倍** | 所有物理/魔法伤害×1.4（+40%伤害） |
| 第4名 | **1.3倍** | 所有物理/魔法伤害×1.3（+30%伤害） |
| 第5名 | **1.2倍** | 所有物理/魔法伤害×1.2（+20%伤害） |
| 第6名 | **1.1倍** | 所有物理/魔法伤害×1.1（+10%伤害） |
| 第7名 | **1.0倍** | 无加成 |

**战败方攻击加成**：

| 名次 | 加成倍数 | 效果说明 |
|------|---------|---------|
| 第1名 | **1.5倍** | 所有物理/魔法伤害×1.5（+50%伤害） |
| 第2名 | **1.3倍** | 所有物理/魔法伤害×1.3（+30%伤害） |
| 第3名 | **1.2倍** | 所有物理/魔法伤害×1.2（+20%伤害） |
| 第4名 | **1.1倍** | 所有物理/魔法伤害×1.1（+10%伤害） |

**攻击加成计算方式**：

攻击加成作用于**最终伤害计算**，会同时影响：
- **物理攻击伤害**（iAP_SM、iAP_L）：近战、远程物理攻击
- **魔法攻击伤害**（iDamage）：所有魔法技能伤害

**计算公式**：
```
最终伤害 = 原始伤害 × 攻击加成倍数
```

**举例**：
- 第1名（胜利方）原本打1000伤害 → 实际造成 1000 × 1.7 = **1700伤害**
- 第1名（战败方）原本打1000伤害 → 实际造成 1000 × 1.5 = **1500伤害**

**配置文件**（Settings.cfg）：
```ini
国战胜利方攻击加成 = 1.7    1.5    1.4    1.3    1.2    1.1    1.0
国战失败方攻击加成 = 1.5    1.3    1.2    1.1
```
> 数值从左到右分别对应第1名到第7名（胜利方）或第1-4名（战败方）

---

### 玫瑰花榜攻击加成

除了国战英雄加成外，**送花榜/收花榜**排名也会提供攻击伤害加成。

**加成前提条件**：
- 玩家必须**同时**在送花榜和收花榜上有排名
- 取两个榜单中**排名较低的那个**作为加成依据
- 例如：送花榜第3名 + 收花榜第5名 → 按第5名计算加成

**战士物理攻击加成**（RosePAttRatio）：

| 排名 | 第1名 | 第2名 | 第3名 | 第4名 | 第5名 | 第6名 | 第7名 | 第8名 | 第9名 | 第10名 |
|------|-------|-------|-------|-------|-------|-------|-------|-------|-------|--------|
| 加成 | +70%  | +70%  | +75%  | +25%  | +20%  | +16%  | +14%  | +12%  | +10%  | +8%    |

**法师魔法攻击加成**（RoseMAttRatio）：

| 排名 | 第1名 | 第2名 | 第3名 | 第4名 | 第5名 | 第6名 | 第7名 | 第8名 | 第9名 | 第10名 |
|------|-------|-------|-------|-------|-------|-------|-------|-------|-------|--------|
| 加成 | +70%  | +55%  | +35%  | +25%  | +20%  | +16%  | +14%  | +12%  | +10%  | +8%    |

**计算公式**：
```
最终伤害 = 原始伤害 + (原始伤害 × 加成百分比 / 100)
```

**举例**：
- 战士第1名，原本打1000物理伤害 → 实际造成 1000 + 1000×70% = **1700伤害**
- 法师第3名，原本打1000魔法伤害 → 实际造成 1000 + 1000×35% = **1350伤害**

**配置文件**（RandomDrop.cfg）：
```ini
// 战士送收玫瑰攻击加成
RosePAttRatio = 70 70 75 25 20 16 14 12 10 8
// 法师送收玫瑰攻击加成
RoseMAttRatio = 70 55 35 25 20 16 14 12 10 8
```
> 数值从左到右分别对应第1名到第10名，单位为百分比

**注意事项**：
1. 战士用`RosePAttRatio`（P=Physical物理），法师用`RoseMAttRatio`（M=Magic魔法）
2. 玫瑰花榜加成与国战英雄加成**可以叠加**
3. 如果只在一个榜上有排名（只送不收或只收不送），则没有加成
4. 默认初始值为100（表示不在榜上），只有0-9才有加成

---

### 天使榜血量加成

天使等级榜前10名会获得**血量百分比加成**（不需要称号，直接生效）。

**血量加成表**（AngelRatio）：

| 排名 | 第1名 | 第2名 | 第3名 | 第4名 | 第5名 | 第6名 | 第7名 | 第8名 | 第9名 | 第10名 |
|------|-------|-------|-------|-------|-------|-------|-------|-------|-------|--------|
| 加血 | +15%  | +13%  | +12%  | +10%  | +9%   | +7%   | +5%   | +3%   | +2%   | +1%    |

**计算公式**：
```
血量加成 = 基础血量上限 × 加成百分比 / 100
最终血量上限 = 基础血量上限 + 血量加成
```

**举例**：
- 基础血量1000，第1名 → 加成 1000 × 15% = **+150血量** → 最终1150
- 基础血量2000，第3名 → 加成 2000 × 12% = **+240血量** → 最终2240

**配置文件**（RandomDrop.cfg）：
```ini
// 天使等级加成血量（百分比）
AngelRatio = 15 13 12 10 9 7 5 3 2 1
```
> 数值从左到右分别对应第1名到第10名，单位为百分比

**排名依据**：按天使等级排序，等级相同则按天使经验排序

**客户端显示**：
- 当血量加成变化时，事件栏会显示消息：`"你的生命值上限提高了:X."` 或 `"你的生命值上限降低了:X."`
- HP条会显示更高的血量上限
- 注意：客户端不会显示"天使榜加成"的明确标识，只显示总血量变化

---

### 其他奖励

- **金币奖励**（所有参战玩家）：贡献值 × 金币倍率（服务器配置）
- **竞技场积分**（如果开启）：
  - 获胜方所有人：+15分
  - 战败方所有人：+8分
  - 第1名额外：+12分
  - 第2名额外：+10分
  - 第3名额外：+8分
  - 第4-7名额外：+4-7分

---

## 管理员查询玩家贡献值

当玩家反馈排名问题时，可以通过以下方式查询：

### 方法一：查看角色存档文件

角色存档位置：`WorldServer\Character\AscII{首字符ASCII码}\角色名.txt`

**示例**：角色名为 `alice`，首字母 `a` 的ASCII码是97，所以存档位置是：
```
WorldServer\Character\AscII97\alice.txt
```

在存档文件中搜索以下字段：
```
character-war-contribution = 0
```
这就是该玩家的**当前战争贡献值**。

**重要说明**：
- 战争贡献值在**国战开始时**归零（而非国战结束时）
- 国战结束后，玩家的贡献值会保留，直到下次国战开始
- 这意味着你可以在国战结束后随时查询玩家的上次国战贡献值

### 方法二：查看服务器日志（国战期间）

日志位置：`GameServerLog\GameServerLog{日期}.log`

国战期间，服务器会输出以下日志：

**击杀敌方玩家时**：
```
Enemy Player Killed by Player! Construction: +XX WarContribution +XXXX
```

**击杀敌方NPC/建筑时**：
```
Enemy Npc Killed by player! Construction: +XXX WarContribution: +XXXX
```

**国战结束时会公告前7名**：
```
阿瑞登国战第一名:玩家名,奖励XX个上古印记
阿瑞登国战第二名:玩家名,奖励XX个上古印记
...
```

### 方法三：理解排名计算时机

**重要**：排名是在**国战结束的瞬间**根据**当时在线玩家**的贡献值进行计算的。

这意味着：
- 如果玩家在国战结束前下线，他的贡献值**不会被计入排名**
- 只有国战结束时在线的玩家才参与排名
- 贡献值会保存在角色存档中，但排名只看结算瞬间的在线玩家

**这是玩家常见疑惑的另一个原因**：玩家可能贡献值很高，但如果在国战结算时不在线，就无法上榜。

---

## 技术细节（开发参考）

### 战争贡献值数据结构

- **变量名**：`m_iWarContribution`
- **数据类型**：int
- **最大值**：1,000,000
- **初始值**：0（国战开始时重置）

### 排名算法

系统使用插入排序算法实时维护前10名排行榜：
1. 遍历所有**当前在线**玩家
2. 跳过管理员账号
3. 按阵营分别比较战争贡献值
4. 维护两个阵营各自的前10名数组
5. 国战结束时，只给**获胜方**前7名设置称号

### 相关代码位置

- 排名计算逻辑：[NewPartySystem.cpp](HGServer/NewPartySystem.cpp#L28450-L28900)
- 击杀玩家贡献：[Game.cpp](HGServer/Game.cpp#L31765)
- 建造设施贡献：[Game.cpp](HGServer/Game.cpp#L14976)
- 击杀NPC贡献：[Game.cpp](HGServer/Game.cpp#L16930-L17100)
- 军团长加成：[NewPartySystem.cpp](HGServer/NewPartySystem.cpp#L31318)
- 战败方补偿：[NewPartySystem.cpp](HGServer/NewPartySystem.cpp#L28341)
- 称号设置：[NewPartySystem.cpp](HGServer/NewPartySystem.cpp#L28750-L28890)

---

*文档更新时间：2025年12月24日*
